<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Discord-klon — Servrar & DMs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{
        --bg:#0f1724;
        --sidebar:#0b1220;
        --muted:#94a3b8;
        --accent:#5865f2;
      }
      body { background: linear-gradient(180deg,var(--bg),#071027); }
      .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
      .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
      .server-icon { width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700; }
      .unread-dot{width:8px;height:8px;border-radius:50%;background:#f43f5e}
    </style>
  </head>
  <body class="min-h-screen text-sm text-white">
    <div id="root"></div>

    <!-- React + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      /*******************************
       * Data + Persistence Helpers
       *******************************/
      const STORAGE_KEY = 'discord_demo_v3';

      function defaultData() {
        return {
          servers: {
            s_home: {
              id: 's_home',
              name: 'Hem',
              icon: 'H',
              channels: {
                general: { id: 'general', name: 'general', messages: [
                  { id: 'm1', user: 'Anna', text: 'Välkommen till Hem!', ts: new Date().toISOString() }
                ] },
                announcements: { id: 'announcements', name: 'announcements', messages: [] },
              },
              members: ['Anna','Björn','Cara']
            },
            s_gaming: {
              id: 's_gaming',
              name: 'Gaming',
              icon: 'G',
              channels: {
                general: { id: 'general', name: 'general', messages: [] },
                memes: { id: 'memes', name: 'memes', messages: [] }
              },
              members: ['Anna','Dave','Eve']
            }
          },
          dms: {
            // structure: recipient -> messages array
            // e.g. "Cara": [{id..., from: 'You', to:'Cara', text, ts}]
          }
        };
      }

      function saveData(data) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
      }
      function loadData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return defaultData();
          return JSON.parse(raw);
        } catch(e) { return defaultData(); }
      }

      function getUser() { return localStorage.getItem('discord_user'); }
      function setUser(user) { localStorage.setItem('discord_user', user); }
      function clearUser(){ localStorage.removeItem('discord_user'); }

      /*******************************
       * Login Component
       *******************************/
      function Login({ onLogin }) {
        const [name, setName] = useState('');
        function submit(e){
          e.preventDefault();
          const trimmed = name.trim();
          if(!trimmed) return;
          setUser(trimmed);
          onLogin(trimmed);
        }
        return (
          <div className="flex items-center justify-center h-screen">
            <form onSubmit={submit} className="w-96 bg-[#111827] p-8 rounded-2xl shadow-xl">
              <h1 className="text-2xl font-semibold mb-4 text-center">Logga in</h1>
              <p className="text-sm text-[#94a3b8] mb-4 text-center">Skriv ditt användarnamn (det sparas i din browser).</p>
              <input value={name} onChange={e=>setName(e.target.value)} className="w-full p-3 rounded bg-[#0b1220] mb-4 outline-none" placeholder="Ex. Linus" />
              <div className="flex gap-2">
                <button className="flex-1 py-3 rounded bg-[--accent] hover:opacity-95">Logga in</button>
                <button type="button" onClick={()=>{ setName('DemoUser'); }} className="px-3 rounded bg-white/6">Demo</button>
              </div>
            </form>
          </div>
        );
      }

      /*******************************
       * ServerList (leftmost column)
       *******************************/
      function ServerList({ servers, activeServer, setActiveServer }) {
        return (
          <div className="w-20 bg-[#071127] p-2 flex flex-col gap-3 items-center border-r border-black/20">
            {Object.values(servers).map(s => (
              <button key={s.id} onClick={()=>setActiveServer(s.id)} title={s.name} className={`server-icon ${activeServer === s.id ? 'ring-2 ring-white/10' : 'hover:bg-white/5'} bg-[#0e1420]`}>
                <span style={{fontSize: '18px'}}>{s.icon || s.name[0]}</span>
              </button>
            ))}
            <div className="mt-auto text-xs text-[#94a3b8]">Demo</div>
          </div>
        );
      }

      /*******************************
       * Channels Sidebar (per-server)
       *******************************/
      function ChannelsSidebar({ server, activeChannel, setActiveChannel, onCreateChannel }) {
        const channels = Object.values(server.channels || {});
        return (
          <div className="w-64 bg-[#0b1220] p-3 flex flex-col border-r border-black/20">
            <div className="flex items-center justify-between mb-3">
              <div>
                <div className="font-bold text-lg">{server.name}</div>
                <div className="text-xs text-[#94a3b8]">{(server.members||[]).length} medlemmar</div>
              </div>
              <button onClick={onCreateChannel} className="px-2 py-1 text-sm rounded bg-white/6">+ kanal</button>
            </div>

            <div className="text-xs text-[#94a3b8] mb-2">TEXTKANALER</div>
            <div className="flex-1 overflow-auto scrollbar-thin">
              {channels.map(ch => (
                <div key={ch.id} onClick={()=>setActiveChannel(ch.id)} className={`px-3 py-2 rounded cursor-pointer flex items-center justify-between ${activeChannel === ch.id ? 'bg-white/6' : 'hover:bg-white/5'}`}>
                  <div className="flex items-center gap-2">
                    <span className="text-[#9aa9c7]">#</span>
                    <div>
                      <div className="font-medium">{ch.name}</div>
                      <div className="text-xs text-[#94a3b8]">{(ch.messages?.length || 0) ? `${ch.messages.length} meddelanden` : 'Ingen topic'}</div>
                    </div>
                  </div>
                  { (ch.messages?.length || 0) > 0 && <div className="text-xs text-[#94a3b8]">{ch.messages.length}</div> }
                </div>
              ))}
            </div>
          </div>
        );
      }

      /*******************************
       * Members + DM list (rightmost)
       *******************************/
      function RightPanel({ members, onOpenDM, activeDM, user }) {
        return (
          <div className="w-64 bg-[#071428] p-3 border-l border-black/20 flex flex-col">
            <div className="font-semibold mb-2">Direktmeddelanden</div>

            <div className="mb-3 overflow-auto scrollbar-thin" style={{maxHeight: '30vh'}}>
              {members.map(m => (
                <div key={m} className="flex items-center gap-2 px-2 py-1 hover:bg-white/5 rounded cursor-pointer" onClick={()=>onOpenDM(m)}>
                  <div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{m[0]}</div>
                  <div className="flex-1">
                    <div className="font-medium">{m}</div>
                    <div className="text-xs text-[#94a3b8]">online</div>
                  </div>
                  { activeDM === m && <div className="text-xs text-[#94a3b8]">Öppnad</div> }
                </div>
              ))}
            </div>

            <div className="mt-auto pt-3 border-t border-black/20">
              <div className="text-xs text-[#94a3b8] mb-2">Din användare</div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-[#1e2a3a] flex items-center justify-center">{user[0]}</div>
                  <div>
                    <div className="font-medium">{user}</div>
                    <div className="text-xs text-[#94a3b8]">Online</div>
                  </div>
                </div>
                <div>
                  <button title="Logga ut" className="px-2 py-1 rounded bg-red-600/30" onClick={() => { clearUser(); location.reload(); }}>Logga ut</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /*******************************
       * Messages view (central)
       *******************************/
      function MessagesView({ title, messages }) {
        return (
          <div className="flex-1 overflow-auto p-6 scrollbar-thin">
            <div className="max-w-3xl flex flex-col gap-4">
              <div className="text-sm text-[#94a3b8] mb-2"># {title}</div>
              {messages.length === 0 && <div className="text-[#94a3b8]">Inga meddelanden än — skriv något nedan.</div>}
              {messages.map(m => (
                <div key={m.id} className="flex gap-3">
                  <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{(m.from || m.user || m.sender || 'U')[0]}</div>
                  <div>
                    <div className="flex items-center gap-2">
                      <div className="font-medium">{m.from || m.user || m.sender || 'Användare'}</div>
                      <div className="text-xs text-[#94a3b8]">{new Date(m.ts).toLocaleString()}</div>
                    </div>
                    <div className="mt-1">{m.text}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      /*******************************
       * Input component
       *******************************/
      function Composer({ placeholder, onSend }) {
        const ref = useRef();
        function send() {
          const v = ref.current.value.trim();
          if(!v) return;
          onSend(v);
          ref.current.value = '';
        }
        function onKey(e){
          if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); send();
          }
        }
        return (
          <div className="p-4 border-t border-black/20">
            <div className="max-w-3xl mx-auto flex gap-2">
              <textarea ref={ref} onKeyDown={onKey} placeholder={placeholder} className="flex-1 bg-[#071225] rounded px-4 py-3 outline-none resize-none" rows="2"></textarea>
              <button onClick={send} className="bg-[#5865f2] px-4 py-3 rounded">Skicka</button>
            </div>
          </div>
        );
      }

      /*******************************
       * Main App
       *******************************/
      function AppRoot() {
        const [me, setMe] = useState(getUser());
        const [data, setData] = useState(() => loadData());
        // UI state:
        const [activeServer, setActiveServer] = useState(Object.keys(data.servers)[0]);
        const [activeChannel, setActiveChannel] = useState(() => {
          const s = Object.values(data.servers)[0];
          return s && Object.keys(s.channels)[0];
        });
        const [activeDM, setActiveDM] = useState(null);
        const [view, setView] = useState('server'); // 'server' or 'dm'

        useEffect(()=>{ saveData(data); }, [data]);

        useEffect(()=>{
          // if data changes and active server/channel no longer exist, reset
          if(!data.servers[activeServer]) {
            setActiveServer(Object.keys(data.servers)[0] || null);
          }
        }, [data]);

        function handleLogin(user){
          setMe(user);
          // add user to servers' members lists (if not present)
          const copy = {...data};
          Object.values(copy.servers).forEach(s=>{
            if(!s.members.includes(user)) s.members.push(user);
          });
          setData(copy);
        }

        function createChannel() {
          const name = prompt('Namn på ny kanal (utan mellanslag):');
          if(!name) return;
          const copy = {...data};
          const s = copy.servers[activeServer];
          if(s.channels[name]) { alert('Kanal finns redan'); return; }
          s.channels[name] = { id:name, name, messages: [] };
          setData(copy);
          setActiveChannel(name);
        }

        function sendChannelMessage(text) {
          const id = Date.now().toString();
          const copy = {...data};
          const ch = copy.servers[activeServer].channels[activeChannel];
          ch.messages = [...(ch.messages||[]), { id, user: me, text, ts: new Date().toISOString() }];
          setData(copy);
        }

        function openDM(recipient) {
          setView('dm');
          setActiveDM(recipient);
          // ensure DM array exists
          const copy = {...data};
          if(!copy.dms[recipient]) copy.dms[recipient] = [];
          setData(copy);
        }

        function sendDM(text) {
          if(!activeDM) return;
          const id = Date.now().toString();
          const copy = {...data};
          copy.dms[activeDM] = [...(copy.dms[activeDM]||[]), { id, from: me, to: activeDM, text, ts: new Date().toISOString() }];
          // also mirror a copy under your own dms (for simplicity)
          if(!copy.dms[me]) copy.dms[me] = [];
          copy.dms[me] = [...copy.dms[me], { id: id + '_mirror', from: me, to: activeDM, text, ts: new Date().toISOString() }];
          setData(copy);
        }

        if(!me) {
          return <Login onLogin={handleLogin} />;
        }

        // derive lists
        const server = data.servers[activeServer];
        const channelMessages = server?.channels?.[activeChannel]?.messages || [];
        const members = server?.members || [];

        return (
          <div className="flex h-screen">
            <ServerList servers={data.servers} activeServer={activeServer} setActiveServer={(sid) => { setActiveServer(sid); const firstCh = Object.keys(data.servers[sid].channels)[0]; setActiveChannel(firstCh); setView('server'); }} />
            <ChannelsSidebar server={server} activeChannel={activeChannel} setActiveChannel={(ch)=>{ setActiveChannel(ch); setView('server'); }} onCreateChannel={createChannel} />
            <div className="flex-1 flex flex-col">
              <div className="flex items-center justify-between px-6 py-4 border-b border-black/30">
                <div>
                  { view === 'server' ? (
                    <>
                      <div className="text-lg font-semibold">#{activeChannel}</div>
                      <div className="text-xs text-[#94a3b8]">Server: {server?.name}</div>
                    </>
                  ) : (
                    <>
                      <div className="text-lg font-semibold">DM — {activeDM}</div>
                      <div className="text-xs text-[#94a3b8]">Privat konversation</div>
                    </>
                  )}
                </div>

                <div className="flex items-center gap-3">
                  <button onClick={()=>{ setView('server'); setActiveDM(null); }} className={`px-3 py-1 rounded ${view==='server' ? 'bg-white/6' : 'bg-white/4/0'}`}>Server</button>
                  <button onClick={()=>{ setView('dm'); }} className={`px-3 py-1 rounded ${view==='dm' ? 'bg-white/6' : ''}`}>DM</button>
                  <div className="text-xs text-[#94a3b8]">Inloggad som {me}</div>
                </div>
              </div>

              { view === 'server' ? (
                <>
                  <MessagesView title={`${server?.name} / ${activeChannel}`} messages={channelMessages} />
                  <Composer placeholder={`Skriv i #${activeChannel}... (Enter skickar)` } onSend={sendChannelMessage} />
                </>
              ) : (
                <>
                  <div className="flex-1 flex">
                    <div className="w-full flex flex-col">
                      { activeDM ? (
                        <>
                          <MessagesView title={`DM: ${activeDM}`} messages={(data.dms[activeDM]||[])} />
                          <Composer placeholder={`Skicka DM till ${activeDM}...`} onSend={sendDM} />
                        </>
                      ) : (
                        <div className="flex-1 p-6 text-[#94a3b8]">Välj en användare till höger för att starta en privat konversation.</div>
                      )}
                    </div>
                  </div>
                </>
              )}
            </div>

            <RightPanel members={members.filter(m=>m!==me)} onOpenDM={(m)=>{ openDM(m); setActiveDM(m); }} activeDM={activeDM} user={me} />
          </div>
        );
      }

      /*******************************
       * Render root
       *******************************/
      ReactDOM.createRoot(document.getElementById('root')).render(<AppRoot />);
    </script>
  </body>
</html>
