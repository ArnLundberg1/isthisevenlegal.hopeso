<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discord-klon — Fullversion (LocalStorage)</title>

  <!-- Tailwind for snabb styling (ingen build-step) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + Babel (kör allt i-browser så filen är single-file) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Grundfärger & scrollbars */
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#94a3b8;
      --accent:#5865f2;
    }
    body { background: linear-gradient(180deg,var(--bg),#071027); font-family: Inter, Roboto, system-ui, sans-serif; }
    .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
    .server-icon { width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700; }
    .modal-backdrop{ background: rgba(0,0,0,0.6); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; }
    .category-header { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; margin-top: 8px; margin-bottom: 6px; }
    .thread-badge { background: rgba(255,255,255,0.06); padding:2px 6px; border-radius:999px; font-size:11px; }
    .notif-dot { width:9px; height:9px; border-radius:50%; background:#f43f5e; display:inline-block; margin-left:8px; }
    textarea { font-family: inherit; }
    /* Fokus-styling: viktigt för att visa att elementet är aktivt */
    input:focus, textarea:focus, button:focus { outline: none; box-shadow: 0 0 0 3px rgba(88,101,242,0.14); }
  </style>
</head>
<body class="text-white">

  <!-- Root -->
  <div id="root"></div>

  <!-- App code (Babel) -->
  <script type="text/babel">
  /**
   * Komplett single-file React app.
   * Viktigt: all state sparas i localStorage (nycklar i kommentarerna nedan).
   *
   * Nycklar i localStorage:
   * - USERS_KEY: registrerade användare
   * - DATA_KEY: servrar, kanaler, invites, DMs, emojis, friends, typing, unread
   * - SESSION_KEY: nuvarande inloggad användare
   *
   * Säkerhet: lösenord kodas med btoa (ej säkert i produktion).
   *
   * Admin Panel: Ctrl + Alt + Tab -> lösenord 'admin12'
   *
   * Notera: voice är simulerat (ingen WebRTC).
   */

  const { useState, useEffect, useRef } = React;

  /*********************************************************
   * Konstanter & hjälpfunktioner
   *********************************************************/
  const USERS_KEY = 'discord_super_users_v1';
  const DATA_KEY = 'discord_super_data_v1';
  const SESSION_KEY = 'discord_super_session_v1';
  const ADMIN_PW = 'admin12';

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    } catch(e){
      return fallback;
    }
  }
  function saveJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
  function hashPw(pw){ return btoa(pw); } // Demo only - DO NOT USE IN PRODUCTION
  function dmKey(a,b){ return [a,b].sort().join('|'); }

  // Boot: skapa tom data-objekt om inte finns
  (function boot(){
    if(!localStorage.getItem(DATA_KEY)){
      saveJSON(DATA_KEY, {
        servers: {}, // serverId -> server object
        dms: {},     // dmKey -> messages array
        emojis: {},  // name -> dataURI or unicode
        friends: {}, // username -> { requests:[], friends:[], blocked:[] }
        typing: {},  // roomKey -> {user, ts}
        unread: {}   // username|roomKey -> count (per-user unread)
      });
    }
    if(!localStorage.getItem(USERS_KEY)){
      saveJSON(USERS_KEY, {}); // inga förifyllda users
    }
  })();

  /*********************************************************
   * AdminPanel - visar/edit localStorage
   * Öppnas med Ctrl + Alt + Tab (i App useEffect)
   *********************************************************/
  function AdminPanel({ onClose }) {
    const [keys, setKeys] = useState(Object.keys(localStorage).sort());
    const [selected, setSelected] = useState(null);
    const [content, setContent] = useState('');

    useEffect(()=> setKeys(Object.keys(localStorage).sort()), []);

    useEffect(()=> {
      if(selected){
        setContent(localStorage.getItem(selected) || '');
      } else setContent('');
    },[selected]);

    function saveSelected(){
      try{
        localStorage.setItem(selected, content);
        alert('Sparat!');
        setKeys(Object.keys(localStorage).sort());
      } catch(e){
        alert('Fel: '+e.message);
      }
    }
    function clearKey(){
      if(!selected) return;
      if(confirm('Rensa '+selected+'?')){
        localStorage.removeItem(selected);
        setSelected(null);
        setContent('');
        setKeys(Object.keys(localStorage).sort());
      }
    }
    function exportAll(){
      const obj = {};
      for(const k of Object.keys(localStorage)) obj[k] = localStorage.getItem(k);
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'discord_export.json'; a.click();
      URL.revokeObjectURL(url);
    }
    function importAll(){
      const txt = prompt('Klistra in JSON (eller avbryt):');
      if(!txt) return;
      try{
        const obj = JSON.parse(txt);
        for(const [k,v] of Object.entries(obj)) localStorage.setItem(k, v);
        alert('Import klart — ladda om sidan för att se förändringar');
        window.location.reload();
      } catch(e){
        alert('Fel i JSON: '+e.message);
      }
    }

    return (
      <div className="modal-backdrop">
        <div className="bg-[#0b1220] w-[900px] h-[600px] rounded-lg p-4 flex flex-col">
          <div className="flex justify-between items-center mb-3">
            <div className="text-lg font-semibold">Admin Panel</div>
            <div className="flex gap-2">
              <button onClick={exportAll} className="px-3 py-1 bg-white/6 rounded">Exportera</button>
              <button onClick={importAll} className="px-3 py-1 bg-white/6 rounded">Importera</button>
              <button onClick={onClose} className="px-3 py-1 bg-red-600/30 rounded">Stäng</button>
            </div>
          </div>
          <div className="flex-1 flex gap-2">
            <div className="w-64 bg-[#071428] p-2 overflow-auto scrollbar-thin">
              {keys.map(k => (
                <div key={k} className={`p-2 cursor-pointer ${k===selected ? 'bg-white/6' : ''}`} onClick={()=>setSelected(k)}>{k}</div>
              ))}
            </div>
            <div className="flex-1 flex flex-col">
              <textarea className="flex-1 bg-[#071225] p-3 font-mono text-xs resize-none" value={content} onChange={(e)=>setContent(e.target.value)} />
              <div className="mt-2 flex gap-2">
                <button onClick={saveSelected} className="px-3 py-1 bg-green-600/40 rounded">Spara</button>
                <button onClick={clearKey} className="px-3 py-1 bg-red-600/40 rounded">Rensa</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /*********************************************************
   * Auth (Login/Register)
   * - register saves into USERS_KEY
   * - login sets SESSION_KEY
   *
   * Vi ser till att input-fokus inte försvinner när UI re-renderas.
   *********************************************************/
  function Auth({ onLogin }) {
    const [mode, setMode] = useState('login'); // 'login' or 'register'
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const userRef = useRef(null);

    useEffect(()=> {
      // sätt initial fokus på användarnamn
      if(userRef.current) userRef.current.focus();
    }, []);

    function handleLogin(e){
      e.preventDefault();
      const users = loadJSON(USERS_KEY, {});
      if(!users[username]) { alert('Ingen sådan användare'); return; }
      if(users[username].pw !== hashPw(password)) { alert('Fel lösenord'); return; }
      saveJSON(SESSION_KEY, username);
      // se till att friends-data existerar
      ensureFriendData(username);
      onLogin(username);
    }

    function handleRegister(e){
      e.preventDefault();
      if(!username.trim()) return alert('Användarnamn krävs');
      if(password.length < 4) return alert('Lösenord minst 4 tecken');
      const users = loadJSON(USERS_KEY, {});
      if(users[username]) return alert('Användarnamn upptaget');
      users[username] = { pw: hashPw(password), created: Date.now(), bio: '' };
      saveJSON(USERS_KEY, users);
      saveJSON(SESSION_KEY, username);
      ensureFriendData(username);
      onLogin(username);
    }

    return (
      <div className="h-screen flex items-center justify-center">
        <div className="w-96 bg-[#0f1724] p-6 rounded-2xl shadow-lg">
          <h1 className="text-2xl font-semibold mb-4">Discord-klon</h1>
          <div className="flex gap-2 mb-4">
            <button onClick={()=>setMode('login')} className={`flex-1 py-2 rounded ${mode==='login' ? 'bg-white/6' : ''}`}>Logga in</button>
            <button onClick={()=>setMode('register')} className={`flex-1 py-2 rounded ${mode==='register' ? 'bg-white/6' : ''}`}>Skapa konto</button>
          </div>

          <form onSubmit={mode==='login' ? handleLogin : handleRegister} className="flex flex-col gap-3">
            <input ref={userRef} value={username} onChange={e=>setUsername(e.target.value)} className="p-2 rounded bg-[#071225]" placeholder="Användarnamn" />
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="p-2 rounded bg-[#071225]" placeholder="Lösenord" />
            <div className="flex gap-2">
              <button type="submit" className="flex-1 bg-[--accent] py-2 rounded">{mode==='login' ? 'Logga in' : 'Registrera'}</button>
              <button type="button" onClick={()=>{
                // demo quick account: generera slumpnamn, spara lokalt
                const name = 'user' + Math.floor(Math.random()*9000+1000);
                const users = loadJSON(USERS_KEY, {});
                users[name] = { pw: hashPw('demo'), created: Date.now(), bio: '' };
                saveJSON(USERS_KEY, users);
                saveJSON(SESSION_KEY, name);
                ensureFriendData(name);
                onLogin(name);
              }} className="px-3 py-2 bg-white/6 rounded">Demo</button>
            </div>
          </form>

          <div className="text-xs text-[--muted] mt-3">
            Tips: Demo-skapar snabbt konto. Lösenord lagras lokalt (btoa) — ej säkert i produktion.
          </div>
        </div>
      </div>
    );
  }

  /*********************************************************
   * Små hjälpare: friends-init, emoji-pickers, user profile modal
   *********************************************************/
  function ensureFriendData(username){
    const data = loadJSON(DATA_KEY, { servers:{}, dms:{}, emojis:{}, friends:{}, typing:{}, unread:{} });
    data.friends = data.friends || {};
    if(!data.friends[username]) data.friends[username] = { requests: [], friends: [], blocked: [] };
    saveJSON(DATA_KEY, data);
  }

  function UserProfile({ username, serverObj, onClose }){
    // visar enkel profil, bio, registreringsdatum och roll i server (om serverObj given)
    const users = loadJSON(USERS_KEY, {});
    const user = users[username] || {};
    const role = serverObj ? (serverObj.memberRoles?.[username] || 'Member') : null;
    return (
      <div className="modal-backdrop" onClick={onClose}>
        <div className="bg-[#0b1220] rounded p-4 w-96" onClick={e=>e.stopPropagation()}>
          <div className="flex items-center gap-3 mb-2">
            <div className="w-12 h-12 rounded-full bg-[#1e2a3a] flex items-center justify-center">{username[0]}</div>
            <div>
              <div className="font-semibold">{username}</div>
              {role && <div className="text-xs text-[--muted]">{role}</div>}
              <div className="text-xs text-[--muted]">Registrerad: {user.created ? new Date(user.created).toLocaleDateString() : 'N/A'}</div>
            </div>
          </div>
          <div className="mb-3 text-sm">{user.bio || 'Ingen bio'}</div>
          <div className="flex justify-end">
            <button onClick={onClose} className="px-3 py-1 bg-white/6 rounded">Stäng</button>
          </div>
        </div>
      </div>
    );
  }

  function EmojiPicker({ onPick }){
    // Enkel emoji-lista + custom emojis från data
    const defaults = ['👍','😂','❤️','🔥','🎉','😮','😢','😡'];
    const data = loadJSON(DATA_KEY, { servers:{}, dms:{}, emojis:{}, friends:{}, typing:{}, unread:{} });
    const custom = Object.keys(data.emojis || {});
    const all = [...defaults, ...custom];
    return (
      <div className="bg-[#0b1220] p-2 rounded shadow">
        <div className="grid grid-cols-6 gap-2">
          {all.map(e => <button key={e} onClick={()=>onPick(e)} className="px-2 py-1 rounded hover:bg-white/5">{e}</button>)}
        </div>
      </div>
    );
  }

  /*********************************************************
   * Core App
   *********************************************************/
  function App(){
    // Global state: session user, data (servers, dms, emojis...), users map
    const [me, setMe] = useState(loadJSON(SESSION_KEY, null));
    const [data, setData] = useState(loadJSON(DATA_KEY, { servers:{}, dms:{}, emojis:{}, friends:{}, typing:{}, unread:{} }));
    const [users, setUsers] = useState(loadJSON(USERS_KEY, {}));

    // UI state
    const [activeServer, setActiveServer] = useState(null);
    const [activeCategory, setActiveCategory] = useState(null);
    const [activeChannel, setActiveChannel] = useState(null);
    const [view, setView] = useState('server'); // 'server' or 'dm'
    const [activeDM, setActiveDM] = useState(null);
    const [showAdmin, setShowAdmin] = useState(false);
    const [profileFor, setProfileFor] = useState(null);
    const [threadModal, setThreadModal] = useState(null);
    const [emojiModal, setEmojiModal] = useState(null);
    const [inviteModal, setInviteModal] = useState(null);
    const [friendsPanel, setFriendsPanel] = useState(false);

    // Keep state synced with localStorage changes (across tabs)
    useEffect(()=> {
      function onStorage(e){
        if(e.key === DATA_KEY) setData(loadJSON(DATA_KEY));
        if(e.key === USERS_KEY) setUsers(loadJSON(USERS_KEY));
        if(e.key === SESSION_KEY) setMe(loadJSON(SESSION_KEY));
      }
      window.addEventListener('storage', onStorage);
      return ()=>window.removeEventListener('storage', onStorage);
    }, []);

    // Persist data & users
    useEffect(()=> saveJSON(DATA_KEY, data), [data]);
    useEffect(()=> saveJSON(USERS_KEY, users), [users]);

    // Admin hotkey
    useEffect(()=> {
      function handler(e){
        if(e.ctrlKey && e.altKey && e.key === 'Tab'){
          const pw = prompt('Admin-lösenord:');
          if(pw === ADMIN_PW) setShowAdmin(true);
          else alert('Fel lösenord');
        }
      }
      window.addEventListener('keydown', handler);
      return ()=>window.removeEventListener('keydown', handler);
    }, []);

    // If not logged in -> Auth
    if(!me) return <Auth onLogin={(username)=>{ setMe(username); setUsers(loadJSON(USERS_KEY)); ensureFriendData(username); }} />;

    // utility getters
    function getServer(sid){ return data.servers?.[sid] || null; }
    function getChannelById(sid, cid){
      const s = getServer(sid);
      if(!s) return null;
      for(const catId of Object.keys(s.categories || {})){
        const ch = (s.categories[catId].channels || []).find(c => c.id === cid);
        if(ch) return ch;
      }
      return null;
    }

    /***********************
     * Server creation / category / channel management
     ***********************/
    function createServer(){
      const name = prompt('Namn på server:');
      if(!name) return;
      const sid = name.toLowerCase().replace(/\s+/g,'_') + '_' + Math.floor(Math.random()*9000);
      const copy = JSON.parse(JSON.stringify(data));
      copy.servers = copy.servers || {};
      copy.servers[sid] = {
        id: sid,
        name,
        icon: name[0].toUpperCase(),
        owner: me,
        roles: {
          Owner: { permissions: { manage_server:true, manage_roles:true, manage_channels:true, delete_messages:true, create_messages:true, invite_members:true } },
          Admin: { permissions: { manage_server:false, manage_roles:true, manage_channels:true, delete_messages:true, create_messages:true, invite_members:true } },
          Mod: { permissions: { manage_server:false, manage_roles:false, manage_channels:false, delete_messages:true, create_messages:true, invite_members:false } },
          Member: { permissions: { manage_server:false, manage_roles:false, manage_channels:false, delete_messages:false, create_messages:true, invite_members:false } }
        },
        members: [me],
        memberRoles: { [me]: 'Owner' },
        categories: {},
        invites: {},
        nicknames: {},
        settings: { allowPublicJoin: false }
      };
      // default category + general channel
      const catId = uid('cat');
      copy.servers[sid].categories[catId] = { id:catId, name:'TEXT CHANNELS', collapsed:false, channels: [ { id:'general', name:'general', type:'text', messages:[], pins:[], voiceMembers:[] } ] };
      setData(copy);
      // set active
      setActiveServer(sid);
      setActiveCategory(catId);
      setActiveChannel('general');
    }

    function createCategory(){
      if(!activeServer) return alert('Välj en server');
      const s = getServer(activeServer);
      const role = s.memberRoles?.[me] || 'Member';
      if(!(s.owner === me || s.roles?.[role]?.permissions?.manage_channels)) return alert('Ingen rätt att skapa kategori');
      const name = prompt('Namn på kategori:') || 'Ny kategori';
      const catId = uid('cat');
      const copy = JSON.parse(JSON.stringify(data));
      copy.servers[activeServer].categories[catId] = { id:catId, name, collapsed:false, channels: [] };
      setData(copy);
    }

    function createChannel(catId){
      if(!activeServer) return alert('Välj en server');
      const s = getServer(activeServer);
      const role = s.memberRoles?.[me] || 'Member';
      if(!(s.owner === me || s.roles?.[role]?.permissions?.manage_channels)) return alert('Ingen rätt att skapa kanal');
      const name = prompt('Namn på kanal (utan mellanslag):');
      if(!name) return;
      const type = (prompt('Typ (text/voice):', 'text') === 'voice') ? 'voice' : 'text';
      const copy = JSON.parse(JSON.stringify(data));
      copy.servers[activeServer].categories[catId].channels.push({ id: name, name, type, messages: [], pins: [], voiceMembers: [] });
      setData(copy);
    }

    /***********************
     * Invite codes
     ***********************/
    function generateInvite(serverId){
      const server = getServer(serverId);
      if(!server) return;
      const role = server.memberRoles?.[me] || 'Member';
      if(!(server.owner === me || server.roles?.[role]?.permissions?.invite_members)) return alert('Ingen rätt att skapa invite');
      const code = Math.random().toString(36).slice(2,8);
      const copy = JSON.parse(JSON.stringify(data));
      copy.servers[serverId].invites = copy.servers[serverId].invites || {};
      copy.servers[serverId].invites[code] = { by: me, ts: Date.now() };
      setData(copy);
      alert('Invite skapad: code=' + code + '\nGe koden till andra: de kan använda "Join by code"');
    }
    function joinByCode(){
      const code = prompt('Ange invite-kod:');
      if(!code) return;
      const copy = JSON.parse(JSON.stringify(data));
      for(const sid of Object.keys(copy.servers || {})){
        const srv = copy.servers[sid];
        if(srv.invites && srv.invites[code]){
          if(!srv.members.includes(me)){
            srv.members.push(me);
            srv.memberRoles[me] = 'Member';
            setData(copy);
            alert('Du gick med i ' + srv.name);
          } else alert('Du är redan medlem');
          return;
        }
      }
      alert('Ingen invite hittades');
    }

    /***********************
     * Messages: send/delete/react/pin/threads
     ***********************/
    function sendChannelMessage(catId, channelId, text){
      const s = getServer(activeServer);
      if(!s) return;
      const role = s.memberRoles?.[me] || 'Member';
      const can = s.roles?.[role]?.permissions?.create_messages;
      if(!can) return alert('Ingen rätt att skriva i kanalen');
      const copy = JSON.parse(JSON.stringify(data));
      const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
      if(!ch) return;
      ch.messages.push({ id: uid('m'), user: me, text, ts: new Date().toISOString(), reactions: {}, pinned: false, threads: [] });
      setData(copy);
      // mark unread for others
      for(const member of copy.servers[activeServer].members) {
        if(member !== me) {
          const key = member + '|' + activeServer + '|' + channelId;
          copy.unread = copy.unread || {};
          copy.unread[key] = (copy.unread[key] || 0) + 1;
        }
      }
      saveJSON(DATA_KEY, copy);
    }

    function deleteChannelMessage(catId, channelId, messageId){
      const s = getServer(activeServer);
      if(!s) return;
      const role = s.memberRoles?.[me] || 'Member';
      const canDelete = (s.owner === me) || s.roles?.[role]?.permissions?.delete_messages;
      const copy = JSON.parse(JSON.stringify(data));
      const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
      if(!ch) return;
      const idx = ch.messages.findIndex(m=>m.id===messageId);
      if(idx === -1) return;
      if(ch.messages[idx].user !== me && !canDelete) return alert('Ingen rätt att radera detta meddelande');
      ch.messages.splice(idx,1);
      setData(copy);
    }

    function togglePin(catId, channelId, messageId){
      const copy = JSON.parse(JSON.stringify(data));
      const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
      const m = ch.messages.find(x=>x.id===messageId);
      if(!m) return;
      m.pinned = !m.pinned;
      setData(copy);
    }

    function reactChannelMessage(catId, channelId, messageId, emoji){
      const copy = JSON.parse(JSON.stringify(data));
      const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
      const m = ch.messages.find(x=>x.id===messageId);
      m.reactions = m.reactions || {};
      m.reactions[emoji] = m.reactions[emoji] || [];
      if(!m.reactions[emoji].includes(me)) m.reactions[emoji].push(me);
      else m.reactions[emoji] = m.reactions[emoji].filter(u=>u!==me);
      setData(copy);
    }

    /***********************
     * Typing indicator
     ***********************/
    function setTyping(roomKey){
      const copy = JSON.parse(JSON.stringify(data));
      copy.typing = copy.typing || {};
      copy.typing[roomKey] = { user: me, ts: Date.now() };
      setData(copy);
    }
    function typingUsers(roomKey){
      const t = data.typing && data.typing[roomKey];
      if(!t) return null;
      if(Date.now() - t.ts > 5000) return null;
      return t.user;
    }

    /***********************
     * DM functions
     ***********************/
    function openDMWith(user){
      const key = dmKey(me, user);
      const copy = JSON.parse(JSON.stringify(data));
      copy.dms = copy.dms || {};
      if(!copy.dms[key]) copy.dms[key] = [];
      setData(copy);
      setActiveDM(key);
      setView('dm');
    }
    function sendDM(key, text){
      const copy = JSON.parse(JSON.stringify(data));
      copy.dms = copy.dms || {};
      copy.dms[key] = copy.dms[key] || [];
      copy.dms[key].push({ id: uid('m'), user: me, text, ts: new Date().toISOString(), reactions: {} });
      setData(copy);
      // add unread for other user
      const other = key.split('|').find(x=>x!==me);
      const key2 = other + '|dm|' + key;
      copy.unread = copy.unread || {};
      copy.unread[key2] = (copy.unread[key2] || 0) + 1;
      saveJSON(DATA_KEY, copy);
    }
    function deleteDM(key, msgId){
      const copy = JSON.parse(JSON.stringify(data));
      copy.dms[key] = (copy.dms[key] || []).filter(m=>m.id!==msgId);
      setData(copy);
    }
    function reactDM(key, msgId, emoji){
      const copy = JSON.parse(JSON.stringify(data));
      const m = copy.dms[key].find(x=>x.id===msgId);
      m.reactions = m.reactions || {};
      m.reactions[emoji] = m.reactions[emoji] || [];
      if(!m.reactions[emoji].includes(me)) m.reactions[emoji].push(me);
      else m.reactions[emoji] = m.reactions[emoji].filter(u=>u!==me);
      setData(copy);
    }

    /***********************
     * Friends functions
     ***********************/
    function sendFriendRequest(target){
      const usersMap = loadJSON(USERS_KEY, {});
      if(!usersMap[target]) return alert('Ingen sådan användare');
      const copy = JSON.parse(JSON.stringify(data));
      copy.friends = copy.friends || {};
      if(!copy.friends[target]) copy.friends[target] = { requests: [], friends: [], blocked: [] };
      if(copy.friends[target].requests.includes(me)) return alert('Du har redan skickat en request');
      if(copy.friends[target].friends.includes(me)) return alert('Ni är redan vänner');
      copy.friends[target].requests.push(me);
      setData(copy);
      alert('Friend request skickad till ' + target);
    }
    function acceptFriendRequest(from){
      const copy = JSON.parse(JSON.stringify(data));
      copy.friends = copy.friends || {};
      if(!copy.friends[me]) copy.friends[me] = { requests: [], friends: [], blocked: [] };
      if(!copy.friends[from]) copy.friends[from] = { requests: [], friends: [], blocked: [] };
      copy.friends[me].requests = copy.friends[me].requests.filter(r => r !== from);
      if(!copy.friends[me].friends.includes(from)) copy.friends[me].friends.push(from);
      if(!copy.friends[from].friends.includes(me)) copy.friends[from].friends.push(me);
      setData(copy);
    }
    function removeFriend(friend){
      const copy = JSON.parse(JSON.stringify(data));
      copy.friends = copy.friends || {};
      if(copy.friends[me]) copy.friends[me].friends = copy.friends[me].friends.filter(x=>x!==friend);
      if(copy.friends[friend]) copy.friends[friend].friends = copy.friends[friend].friends.filter(x=>x!==me);
      setData(copy);
    }
    function blockUser(username){
      const copy = JSON.parse(JSON.stringify(data));
      copy.friends = copy.friends || {};
      if(!copy.friends[me]) copy.friends[me] = { requests: [], friends: [], blocked: [] };
      if(!copy.friends[me].blocked.includes(username)) copy.friends[me].blocked.push(username);
      setData(copy);
    }

    /***********************
     * Voice join/leave (simulated)
     ***********************/
    function joinVoice(catId, channelId){
      const copy = JSON.parse(JSON.stringify(data));
      const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
      if(!ch || ch.type!=='voice') return;
      if(!ch.voiceMembers.includes(me)) ch.voiceMembers.push(me);
      setData(copy);
    }
    function leaveVoice(catId, channelId){
      const copy = JSON.parse(JSON.stringify(data));
      const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
      if(!ch || ch.type!=='voice') return;
      ch.voiceMembers = ch.voiceMembers.filter(u=>u!==me);
      setData(copy);
    }

    /***********************
     * Nicknames (per-server)
     ***********************/
    function setNickname(serverId, user){
      const nick = prompt('Ange nick för ' + user + ' på denna server:');
      if(nick === null) return;
      const copy = JSON.parse(JSON.stringify(data));
      copy.servers[serverId].nicknames = copy.servers[serverId].nicknames || {};
      copy.servers[serverId].nicknames[user] = nick;
      setData(copy);
    }

    /***********************
     * Server settings, delete server
     ***********************/
    function openServerSettings(serverId){
      // öppna modal via state
      setInviteModal(null);
      setProfileFor(null);
      setThreadModal(null);
      // markerar save öppnande
      // handled by modal later
    }
    function deleteServer(serverId){
      const s = getServer(serverId);
      if(!s) return;
      if(s.owner !== me && !s.roles?.[ s.memberRoles?.[me] ]?.permissions?.manage_server) return alert('Ingen rätt att ta bort servern');
      if(!confirm('Radera server ' + s.name + '?')) return;
      const copy = JSON.parse(JSON.stringify(data));
      delete copy.servers[serverId];
      setData(copy);
      setActiveServer(null); setActiveChannel(null); setActiveCategory(null);
    }

    /***********************
     * Unread helpers (per-user per-room)
     ***********************/
    function getUnread(username, roomKey){
      const key = username + '|' + roomKey;
      return (data.unread && data.unread[key]) ? data.unread[key] : 0;
    }
    function clearUnread(username, roomKey){
      const copy = JSON.parse(JSON.stringify(data));
      if(copy.unread && copy.unread[username + '|' + roomKey]) delete copy.unread[username + '|' + roomKey];
      setData(copy);
    }

    /***********************
     * UI components: ServerSidebar, ChannelsPanel, CenterPanel, MembersPanel
     * We'll include comments inline to explain behavior.
     ***********************/
    function ServerSidebar(){
      // Left vertical list of servers (and Add button)
      return (
        <div className="w-20 bg-[#071127] p-2 flex flex-col gap-3 items-center border-r border-black/20">
          <button title="Hem (DMs)" onClick={()=>{
            setActiveServer(null); setView('dm'); setActiveDM(null);
          }} className="w-12 h-12 rounded-full bg-[#0e1420] flex items-center justify-center">🏠</button>

          {Object.values(data.servers).map(s => (
            <div key={s.id}>
              <button title={s.name} onClick={()=>{
                setActiveServer(s.id); setView('server'); setActiveDM(null);
                const cats = Object.keys(s.categories || {});
                if(cats.length){ setActiveCategory(cats[0]); const ch = s.categories[cats[0]].channels[0]; if(ch) setActiveChannel(ch.id); }
              }} className={`server-icon bg-[#0e1420] ${activeServer===s.id ? 'ring-2 ring-white/10' : 'hover:scale-105'}`}>{s.icon || s.name[0]}</button>
            </div>
          ))}

          <div className="mt-auto">
            <button onClick={createServer} className="w-12 h-12 rounded-full bg-white/6 flex items-center justify-center">+</button>
          </div>
        </div>
      );
    }

    function ChannelsPanel(){
      // Displays categories and channels for active server
      if(!activeServer) return (
        <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex items-center">
          <div className="text-sm text-[--muted]">Välj en server eller gå till Hem (DMs)</div>
        </div>
      );
      const s = getServer(activeServer);
      return (
        <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex flex-col">
          <div className="flex justify-between items-center mb-3">
            <div>
              <div className="font-bold">{s.name}</div>
              <div className="text-xs text-[--muted]">{s.members.length} medlemmar</div>
            </div>
            <div className="flex gap-2">
              <button onClick={()=>setInviteModal(activeServer)} className="px-2 py-1 rounded bg-white/6">Bjud in</button>
              <button onClick={()=>{ if(s.owner === me) setShowAdmin(true); else alert('Endast owner kan nå admininställningar här'); }} className="px-2 py-1 rounded bg-white/6">Admin</button>
            </div>
          </div>

          <div className="mb-2">
            <div className="text-xs text-[--muted]">Kategorier</div>
            <div className="flex flex-col gap-1">
              {Object.values(s.categories || {}).map(cat => (
                <div key={cat.id}>
                  <div className="category-header flex items-center justify-between">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={()=>{
                      const copy = JSON.parse(JSON.stringify(data));
                      copy.servers[activeServer].categories[cat.id].collapsed = !copy.servers[activeServer].categories[cat.id].collapsed;
                      setData(copy);
                    }}>
                      <span>{cat.collapsed ? '▸' : '▾'}</span>
                      <span className="text-xs">{cat.name}</span>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={()=>{ if(confirm('Skapa kanal i ' + cat.name + '?')) createChannel(cat.id); }} className="text-xs bg-white/6 px-2 py-1 rounded">+ kanal</button>
                    </div>
                  </div>
                  {!cat.collapsed && (
                    <div className="pl-3">
                      {cat.channels.map(ch => (
                        <div key={ch.id} className={`px-2 py-1 rounded cursor-pointer ${activeChannel===ch.id ? 'bg-white/6' : 'hover:bg-white/5'}`} onClick={()=>{
                          setActiveCategory(cat.id); setActiveChannel(ch.id); setView('server');
                          clearUnread(me, activeServer + '|' + ch.id);
                        }}>
                          {ch.type === 'voice' ? '🔊 ' : '# '}{ch.name}
                          { getUnread(me, activeServer + '|' + ch.id) ? <span className="notif-dot"></span> : null }
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>

            <div className="mt-2">
              <button onClick={createCategory} className="w-full py-2 rounded bg-white/6">+ Ny kategori</button>
            </div>

            <div className="mt-3">
              <button onClick={()=>generateInvite(activeServer)} className="w-full py-2 rounded bg-[--accent]">Skapa invite-kod</button>
              <button onClick={()=>joinByCode()} className="w-full py-2 mt-2 rounded bg-white/6">Join by code</button>
            </div>
          </div>
        </div>
      );
    }

    function MembersPanel(){
      // Right panel: member list + actions
      if(!activeServer) return (
        <div className="w-64 bg-[#071428] p-3 border-l border-black/20">
          <div className="text-sm text-[--muted]">Hem / DMs</div>
          <div className="mt-3">
            <button onClick={()=>setFriendsPanel(true)} className="w-full py-2 rounded bg-white/6">Vänner</button>
          </div>
        </div>
      );
      const s = getServer(activeServer);
      return (
        <div className="w-64 bg-[#071428] p-3 border-l border-black/20 flex flex-col">
          <div className="flex items-center justify-between mb-2">
            <div className="font-semibold">Medlemmar</div>
            <div className="text-xs text-[--muted]">Invites</div>
          </div>
          <div className="flex-1 overflow-auto scrollbar-thin">
            {s.members.map(m => (
              <div key={m} className="flex items-center justify-between px-2 py-1 hover:bg-white/5 rounded">
                <div className="flex items-center gap-2">
                  <div onClick={()=>setProfileFor(m)} className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center cursor-pointer">{ (s.nicknames && s.nicknames[m]) ? s.nicknames[m][0] : m[0] }</div>
                  <div>
                    <div className="font-medium">{ (s.nicknames && s.nicknames[m]) ? s.nicknames[m] : m }</div>
                    <div className="text-xs text-[--muted]">{ s.memberRoles?.[m] || 'Member' }</div>
                  </div>
                </div>
                <div className="flex gap-1">
                  <button onClick={()=>openDMWith(m)} className="text-xs bg-white/6 px-2 py-1 rounded">DM</button>
                  {(s.owner === me || s.roles?.[ s.memberRoles?.[me] ]?.permissions?.manage_roles) && <button onClick={()=>setNickname(activeServer,m)} className="text-xs bg-white/6 px-2 py-1 rounded">Nick</button>}
                  {(s.owner === me || s.roles?.[ s.memberRoles?.[me] ]?.permissions?.invite_members) && <button onClick={()=>setInviteModal(activeServer)} className="text-xs bg-[--accent] px-2 py-1 rounded">Bjud in</button>}
                </div>
              </div>
            ))}
          </div>

          <div className="mt-3">
            <div className="text-xs text-[--muted] mb-1">Du: {me}</div>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-10 h-10 rounded-full bg-[#1e2a3a] flex items-center justify-center">{me[0]}</div>
                <div>
                  <div className="font-medium">{me}</div>
                  <div className="text-xs text-[--muted]">Status: Online</div>
                </div>
              </div>
              <div>
                <button onClick={()=>{ saveJSON(SESSION_KEY, null); location.reload(); }} className="text-xs bg-red-600/30 px-2 py-1 rounded">Logga ut</button>
              </div>
            </div>

            <div className="mt-3">
              <button onClick={()=>setFriendsPanel(true)} className="w-full py-2 rounded bg-white/6">Vänner</button>
            </div>
          </div>
        </div>
      );
    }

    /***********************
     * Center panel (either DM view or server/channel view)
     ***********************/
    function CenterPanel(){
      // DM view
      if(view === 'dm'){
        if(!activeDM) return <div className="flex-1 flex items-center justify-center text-[--muted]">Välj en DM</div>;
        const msgs = data.dms[activeDM] || [];
        const other = activeDM.split('|').find(x => x !== me);
        // clear unread for this DM for current user
        clearUnread(me, 'dm|' + activeDM);
        return (
          <div className="flex-1 flex flex-col">
            <div className="px-6 py-4 border-b border-black/30 flex items-center justify-between">
              <div>
                <div className="font-semibold">DM — {other}</div>
                <div className="text-xs text-[--muted]">Privat</div>
              </div>
            </div>

            <div className="flex-1 overflow-auto p-6 scrollbar-thin">
              <div className="max-w-3xl flex flex-col gap-4">
                {msgs.length === 0 && <div className="text-[--muted]">Inga meddelanden än</div>}
                {msgs.map(m => (
                  <div key={m.id} className="flex gap-3">
                    <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{m.user[0]}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <div className="font-medium">{m.user}</div>
                        <div className="text-xs text-[--muted]">{new Date(m.ts).toLocaleTimeString()}</div>
                        <div className="ml-auto flex gap-2">
                          {m.user === me && <button onClick={()=>{ if(confirm('Radera meddelande?')) deleteDM(activeDM, m.id); }} className="text-xs text-red-400">Radera</button>}
                          <button onClick={()=>setThreadModal({ dmKey: activeDM, message: m })} className="text-xs bg-white/6 px-2 py-1 rounded">Tråd</button>
                        </div>
                      </div>
                      <div className="mt-1">{m.text}</div>
                      <div className="mt-2 flex gap-2">
                        {Object.entries(m.reactions || {}).map(([e, arr]) => (
                          <div key={e} className="bg-white/10 px-2 rounded cursor-pointer" title={arr.join(', ')} onClick={()=>reactDM(activeDM, m.id, e)}>{e} {arr.length}</div>
                        ))}
                        <button onClick={()=>{ const e = prompt('Emoji:'); if(e) reactDM(activeDM, m.id, e); }} className="text-xs text-[--muted]">+ Reagera</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <Composer onSend={(t)=>sendDM(activeDM,t)} onTyping={()=>setTyping('dm|' + activeDM)} typing={typingUsers('dm|' + activeDM)} />
          </div>
        );
      }

      // Server/channel view
      if(!activeServer) return <div className="flex-1 flex items-center justify-center text-[--muted]">Välj en server eller gå till Hem (DMs)</div>;
      const s = getServer(activeServer);
      if(!activeCategory || !activeChannel) return <div className="flex-1 flex items-center justify-center text-[--muted]">Välj en kanal</div>;
      const ch = getChannelById(activeServer, activeChannel);
      if(!ch) return <div className="flex-1 flex items-center justify-center text-[--muted]">Kanal ej funnen</div>;

      // clear unread for current user and room
      clearUnread(me, activeServer + '|' + activeChannel);

      if(ch.type === 'voice'){
        return (
          <div className="flex-1 flex flex-col">
            <div className="px-6 py-4 border-b border-black/30 flex items-center justify-between">
              <div>
                <div className="font-semibold">🔊 {ch.name}</div>
                <div className="text-xs text-[--muted]">{ch.voiceMembers.length} online</div>
              </div>
              <div>
                {ch.voiceMembers.includes(me) ? <button onClick={()=>leaveVoice(activeCategory, ch.id)} className="px-3 py-1 rounded bg-red-600/30">Lämna</button> : <button onClick={()=>joinVoice(activeCategory, ch.id)} className="px-3 py-1 rounded bg-[--accent]">Gå med</button>}
              </div>
            </div>

            <div className="flex-1 overflow-auto p-6">
              <div className="max-w-3xl">
                <div className="font-medium mb-3">Deltagare</div>
                {ch.voiceMembers.length === 0 && <div className="text-[--muted]">Ingen i kanalen</div>}
                {ch.voiceMembers.map(u => <div key={u} className="flex items-center gap-3 mb-2"><div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{u[0]}</div><div>{u}{u===me && <span className="text-xs text-[--muted]"> (du)</span>}</div></div>)}
                <div className="mt-4 text-xs text-[--muted]">Röst är simulerat — ingen faktisk ljudöverföring.</div>
              </div>
            </div>
          </div>
        );
      }

      // Text channel
      return (
        <div className="flex-1 flex flex-col">
          <div className="px-6 py-4 border-b border-black/30 flex items-center justify-between">
            <div>
              <div className="font-semibold">#{ch.name}</div>
              <div className="text-xs text-[--muted]">{s.name}</div>
            </div>
            <div className="text-xs text-[--muted]">{typingUsers(activeServer + '|' + activeChannel) ? `${typingUsers(activeServer + '|' + activeChannel)} skriver...` : ''}</div>
          </div>

          <div className="flex-1 overflow-auto p-6 scrollbar-thin">
            <div className="max-w-3xl flex flex-col gap-4">
              {ch.messages.length === 0 && <div className="text-[--muted]">Inga meddelanden än</div>}
              {ch.messages.map(m => (
                <div key={m.id} className="flex gap-3">
                  <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{m.user[0]}</div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <div className="font-medium">{m.user}</div>
                      <div className="text-xs text-[--muted]">{new Date(m.ts).toLocaleTimeString()}</div>
                      <div className="ml-auto flex gap-2">
                        <button onClick={()=>setThreadModal({ serverId: activeServer, catId: activeCategory, channelId: activeChannel, message: m })} className="text-xs bg-white/6 px-2 py-1 rounded">Tråd</button>
                        <button onClick={()=>togglePin(activeCategory, ch.id, m.id)} className="text-xs bg-white/6 px-2 py-1 rounded">{m.pinned ? 'Unpin' : 'Pin'}</button>
                        { (m.user === me || s.owner === me || s.roles?.[ s.memberRoles?.[me] ]?.permissions?.delete_messages) && <button onClick={()=>{ if(confirm('Radera meddelande?')) deleteChannelMessage(activeCategory, ch.id, m.id); }} className="text-xs text-red-400">Radera</button> }
                      </div>
                    </div>
                    <div className="mt-1">{m.text}</div>
                    <div className="mt-2 flex gap-2">
                      {Object.entries(m.reactions || {}).map(([e, arr]) => (
                        <div key={e} className="bg-white/10 px-2 rounded cursor-pointer" title={arr.join(', ')} onClick={()=>reactChannelMessage(activeCategory, ch.id, m.id, e)}>{e} {arr.length}</div>
                      ))}
                      <button onClick={()=>{ setEmojiModal({ onPick: (em) => reactChannelMessage(activeCategory, ch.id, m.id, em) }); }} className="text-xs text-[--muted]">+ Reagera</button>
                    </div>
                    { m.threads && m.threads.length ? <div className="mt-2"><span className="thread-badge">{m.threads.length} trådmeddelanden</span></div> : null }
                  </div>
                </div>
              ))}
            </div>
          </div>

          <Composer onSend={(t)=>sendChannelMessage(activeCategory, ch.id, t)} onTyping={()=>setTyping(activeServer + '|' + activeChannel)} typing={typingUsers(activeServer + '|' + activeChannel)} />
        </div>
      );
    }

    /***********************
     * Composer: återanvänds (fix för fokus)
     * Behåll fokus när knappar klickas: vi undviker att sätta global state som resulterar i att textarea förlorar fokus.
     ***********************/
    function Composer({ onSend, onTyping, typing }){
      const ref = useRef();
      const [showEmoji, setShowEmoji] = useState(false);

      // skickar meddelande
      function send(){
        const txt = ref.current.value.trim();
        if(!txt) return;
        onSend(txt);
        ref.current.value = '';
        // behåll fokus
        ref.current.focus();
      }

      // tangent Enter skickar (Shift+Enter ny rad)
      function onKeyDown(e){
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          send();
        } else {
          onTyping && onTyping();
        }
      }

      return (
        <div className="p-4 border-t border-black/20">
          <div className="max-w-3xl mx-auto flex gap-2 items-end relative">
            <div className="flex-1">
              <textarea ref={ref} rows="2" placeholder="Skriv ett meddelande..." className="w-full bg-[#071225] rounded px-4 py-2 resize-none" onKeyDown={onKeyDown}></textarea>
              { showEmoji && <div className="absolute left-0 bottom-16"><EmojiPicker onPick={(e)=>{ ref.current.value += ' ' + e; ref.current.focus(); }} /></div> }
            </div>
            <div className="flex flex-col gap-2">
              <button onClick={()=>setShowEmoji(s=>!s)} className="px-3 py-2 bg-white/6 rounded">😊</button>
              <button onClick={send} className="bg-[--accent] px-4 py-2 rounded">Skicka</button>
            </div>
          </div>
          { typing ? <div className="text-xs text-[--muted] mt-1">{typing} skriver...</div> : null }
        </div>
      );
    }

    /***********************
     * Invite modal (select registered users OR show codes)
     ***********************/
    function InviteModal({ serverId, onClose }){
      const allUsers = Object.keys(loadJSON(USERS_KEY, {}));
      function invite(u){
        if(!confirm('Bjud in ' + u + '?')) return;
        const copy = JSON.parse(JSON.stringify(data));
        if(!copy.servers[serverId].members.includes(u)){
          copy.servers[serverId].members.push(u);
          copy.servers[serverId].memberRoles[u] = 'Member';
          setData(copy); alert('Inbjuden: ' + u);
        } else alert('Already member');
        onClose();
      }
      return (
        <div className="modal-backdrop" onClick={onClose}>
          <div className="bg-[#0b1220] rounded p-3 w-96" onClick={e=>e.stopPropagation()}>
            <div className="flex justify-between items-center mb-2">
              <div className="font-semibold">Bjud in användare</div>
              <button onClick={onClose} className="px-2 py-1 bg-white/6 rounded">Stäng</button>
            </div>
            <div className="max-h-72 overflow-auto scrollbar-thin">
              {allUsers.map(u => (
                <div key={u} className="flex items-center justify-between px-2 py-1 hover:bg-white/5 rounded">
                  <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{u[0]}</div><div>{u}</div></div>
                  <div><button onClick={()=>invite(u)} className="px-2 py-1 bg-[--accent] rounded">Bjud in</button></div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    /***********************
     * Friends panel modal
     ***********************/
    function FriendsPanel(){
      const fd = data.friends || {};
      const mine = fd[me] || { requests: [], friends: [], blocked: [] };
      const [target, setTarget] = useState('');
      return (
        <div className="modal-backdrop" onClick={()=>setFriendsPanel(false)}>
          <div className="bg-[#0b1220] rounded p-4 w-96" onClick={e=>e.stopPropagation()}>
            <div className="flex justify-between items-center mb-3"><div className="font-semibold">Vänner — {me}</div><button onClick={()=>setFriendsPanel(false)} className="px-2 py-1 bg-white/6 rounded">Stäng</button></div>
            <div className="mb-3">
              <div className="font-medium mb-1">Friend requests</div>
              {mine.requests.length === 0 && <div className="text-[--muted]">Inga requests</div>}
              {mine.requests.map(r => <div key={r} className="flex items-center justify-between px-2 py-1"><div>{r}</div><div className="flex gap-2"><button onClick={()=>{ acceptFriendRequest(r); setData(loadJSON(DATA_KEY)); }} className="px-2 py-1 bg-[--accent] rounded">Acceptera</button><button onClick={()=>{ const c = JSON.parse(JSON.stringify(data)); c.friends[me].requests = c.friends[me].requests.filter(x=>x!==r); setData(c); }} className="px-2 py-1 bg-red-600/30 rounded">Avvisa</button></div></div>)}
            </div>

            <div className="mb-3">
              <div className="font-medium mb-1">Vänner</div>
              {mine.friends.length === 0 && <div className="text-[--muted]">Inga vänner</div>}
              {mine.friends.map(f => <div key={f} className="flex items-center justify-between px-2 py-1"><div>{f}</div><div className="flex gap-2"><button onClick={()=>openDMWith(f)} className="px-2 py-1 bg-white/6 rounded">DM</button><button onClick={()=>{ removeFriend(f); setData(loadJSON(DATA_KEY)); }} className="px-2 py-1 bg-red-600/30 rounded">Ta bort</button></div></div>)}
            </div>

            <div className="mb-3">
              <div className="font-medium mb-1">Skicka friend request</div>
              <div className="flex gap-2">
                <input className="flex-1 p-2 bg-[#071225] rounded" placeholder="Användarnamn" value={target} onChange={e=>setTarget(e.target.value)} />
                <button onClick={()=>{ if(target) { sendFriendRequest(target); setData(loadJSON(DATA_KEY)); setTarget(''); } }} className="px-3 py-2 bg-[--accent] rounded">Skicka</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    /***********************
     * Thread modal (view + add thread messages)
     ***********************/
    function ThreadModal({ info, onClose }){
      // info: { serverId, catId, channelId, message }
      if(!info) return null;
      const { serverId, catId, channelId, message } = info;
      const [text, setText] = useState('');
      const ch = getChannelById(serverId, channelId);
      const threads = message.threads || [];
      function addThread(){
        if(!text.trim()) return;
        const copy = JSON.parse(JSON.stringify(data));
        const m = copy.servers[serverId].categories[catId].channels.find(c=>c.id===channelId).messages.find(x=>x.id===message.id);
        m.threads = m.threads || [];
        m.threads.push({ id: uid('t'), user: me, text: text.trim(), ts: new Date().toISOString() });
        setData(copy);
        setText('');
      }
      return (
        <div className="modal-backdrop" onClick={onClose}>
          <div className="bg-[#0b1220] rounded p-4 w-2/3 max-w-2xl" onClick={e=>e.stopPropagation()}>
            <div className="flex justify-between items-center mb-3">
              <div className="font-semibold">Tråd — {message.user}</div>
              <button onClick={onClose} className="px-2 py-1 bg-white/6 rounded">Stäng</button>
            </div>
            <div className="mb-3">
              <div className="text-xs text-[--muted] mb-2">Originalmeddelande</div>
              <div className="p-3 bg-[#071225] rounded">{message.text}</div>
            </div>

            <div className="mb-3">
              <div className="text-xs text-[--muted] mb-2">Tråd</div>
              <div className="max-h-48 overflow-auto scrollbar-thin">
                {threads.length===0 && <div className="text-[--muted]">Inga trådmeddelanden än</div>}
                {threads.map(t => <div key={t.id} className="mb-2 p-2 bg-[#071225] rounded"><div className="text-xs text-[--muted]">{t.user} - {new Date(t.ts).toLocaleString()}</div><div>{t.text}</div></div>)}
              </div>
            </div>

            <textarea value={text} onChange={e=>setText(e.target.value)} className="w-full bg-[#071225] p-2 rounded mb-2" placeholder="Skriv i tråden..."></textarea>
            <div className="flex justify-end gap-2"><button onClick={addThread} className="px-3 py-1 bg-[--accent] rounded">Skicka</button></div>
          </div>
        </div>
      );
    }

    /***********************
     * Render main layout
     ***********************/
    return (
      <div className="flex h-screen">
        <div><ServerSidebar/></div>
        <div><ChannelsPanel/></div>
        <div className="flex-1"><CenterPanel/></div>
        <div><MembersPanel/></div>

        {/* Floating modals */}
        { showAdmin && <AdminPanel onClose={()=>setShowAdmin(false)} /> }
        { profileFor && <UserProfile username={profileFor} serverObj={ activeServer ? getServer(activeServer) : null } onClose={()=>setProfileFor(null)} /> }
        { threadModal && <ThreadModal info={threadModal} onClose={()=>setThreadModal(null)} /> }
        { emojiModal && <div className="modal-backdrop" onClick={()=>setEmojiModal(null)}><div onClick={e=>e.stopPropagation()} className="bg-[#0b1220] p-4 rounded"><EmojiPicker onPick={(e)=>{ emojiModal.onPick(e); setEmojiModal(null); }} /></div></div> }
        { inviteModal && <InviteModal serverId={inviteModal} onClose={()=>setInviteModal(null)} /> }
        { friendsPanel && <FriendsPanel/> }
      </div>
    );
  } // end App

  /*********************************************************
   * Mount
   *********************************************************/
  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>

