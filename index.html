<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Discord-klon ‚Äî Fullpackad (LocalStorage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{
        --bg:#0f1724;
        --panel:#0b1220;
        --muted:#94a3b8;
        --accent:#5865f2;
      }
      body { background: linear-gradient(180deg,var(--bg),#071027); }
      .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
      .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
      .server-icon { width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700; }
      .modal-backdrop{ background: rgba(0,0,0,0.6); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
      .category-header { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: .06em; margin-top: 8px; margin-bottom: 6px; }
    </style>
  </head>
  <body class="min-h-screen text-sm text-white">
    <div id="root"></div>

    <!-- React + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      /*** Storage keys ***/
      const USERS_KEY = 'discord_full_users';
      const DATA_KEY = 'discord_full_data';
      const SESSION_KEY = 'discord_full_session';
      const ADMIN_PW = 'admin12';

      /*** Helpers ***/
      function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)) || {}; }catch(e){ return {}; } }
      function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
      function loadData(){ try{ return JSON.parse(localStorage.getItem(DATA_KEY)) || { servers:{}, dms:{}, typing:{} }; }catch(e){ return { servers:{}, dms:{}, typing:{} }; } }
      function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
      function loadSession(){ return localStorage.getItem(SESSION_KEY); }
      function saveSession(u){ if(u) localStorage.setItem(SESSION_KEY,u); else localStorage.removeItem(SESSION_KEY); }
      function hashPw(p){ return btoa(p); } // demo only
      function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
      function dmKey(a,b){ return [a,b].sort().join('|'); }

      /*** No prefilled users ‚Äî you must register; bootstrap ensures data object exists ***/
      (function bootstrap(){
        const d = loadData();
        if(!d.servers) d.servers = {};
        if(!d.dms) d.dms = {};
        if(!d.typing) d.typing = {};
        saveData(d);
      })();

      /*** Admin Panel Component ***/
      function AdminPanel({ onClose }){
        const [keys, setKeys] = useState(Object.keys(localStorage).sort());
        const [selected, setSelected] = useState(null);
        const [content, setContent] = useState('');
        useEffect(()=>{ setKeys(Object.keys(localStorage).sort()); },[]);
        useEffect(()=>{ if(selected) setContent(localStorage.getItem(selected) || ''); },[selected]);
        function save(){
          try{
            localStorage.setItem(selected, content);
            alert('Sparat');
            setKeys(Object.keys(localStorage).sort());
          }catch(e){ alert('Fel: '+e.message); }
        }
        function clearKey(){
          if(!selected) return;
          if(confirm('Rensa '+selected+'?')){ localStorage.removeItem(selected); setSelected(null); setContent(''); setKeys(Object.keys(localStorage).sort()); }
        }
        function exportAll(){
          const obj = {};
          for(const k of Object.keys(localStorage)){ obj[k] = localStorage.getItem(k); }
          const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'discord_data_export.json'; a.click();
          URL.revokeObjectURL(url);
        }
        function importAll(){
          const txt = prompt('Klistra in JSON (eller avbryt):');
          if(!txt) return;
          try{
            const obj = JSON.parse(txt);
            for(const [k,v] of Object.entries(obj)){ localStorage.setItem(k, v); }
            setKeys(Object.keys(localStorage).sort());
            alert('Importerat');
            window.location.reload();
          }catch(e){ alert('Fel i JSON: '+e.message); }
        }
        return (
          <div className="modal-backdrop">
            <div className="bg-[#0b1220] rounded p-4 w-[900px] h-[600px] flex flex-col">
              <div className="flex justify-between items-center mb-2">
                <div className="text-lg font-semibold">Admin Panel</div>
                <div className="flex gap-2">
                  <button onClick={exportAll} className="px-3 py-1 bg-white/6 rounded">Exportera</button>
                  <button onClick={importAll} className="px-3 py-1 bg-white/6 rounded">Importera</button>
                  <button onClick={onClose} className="px-3 py-1 bg-red-600/30 rounded">St√§ng</button>
                </div>
              </div>
              <div className="flex-1 flex gap-2">
                <div className="w-64 bg-[#071428] p-2 overflow-auto scrollbar-thin">
                  {keys.map(k => (
                    <div key={k} onClick={()=>setSelected(k)} className={`p-2 cursor-pointer ${selected===k?'bg-white/6':''}`}>{k}</div>
                  ))}
                </div>
                <div className="flex-1 flex flex-col">
                  <div className="flex-1">
                    <textarea value={content} onChange={e=>setContent(e.target.value)} className="w-full h-full bg-[#071225] p-3 font-mono text-xs resize-none" />
                  </div>
                  <div className="mt-2 flex gap-2">
                    <button onClick={save} className="px-3 py-1 bg-green-600/40 rounded">Spara</button>
                    <button onClick={clearKey} className="px-3 py-1 bg-red-600/40 rounded">Rensa</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /*** Auth components ***/
      function Auth({ onLogin }){
        const [tab, setTab] = useState('login');
        return (
          <div className="flex items-center justify-center h-screen">
            <div className="w-96 bg-[#0f1724] p-6 rounded-2xl shadow-xl">
              <h1 className="text-2xl font-semibold mb-3">Discord-klon</h1>
              <div className="flex gap-2 mb-4">
                <button onClick={()=>setTab('login')} className={`flex-1 py-2 rounded ${tab==='login'?'bg-white/6':''}`}>Logga in</button>
                <button onClick={()=>setTab('register')} className={`flex-1 py-2 rounded ${tab==='register'?'bg-white/6':''}`}>Skapa konto</button>
              </div>
              {tab==='login' ? <LoginForm onLogin={onLogin}/> : <RegisterForm onRegister={onLogin}/>}
              <div className="text-xs text-[#94a3b8] mt-3">Logga in med anv√§ndarnamn eller anv√§nd demo-knappen f√∂r ett snabbkonto.</div>
            </div>
          </div>
        );
      }

      function LoginForm({ onLogin }){
        const [user,setUser]=useState(''); const [pw,setPw]=useState('');
        function submit(e){ e.preventDefault();
          const users = loadUsers();
          if(!users[user]) return alert('Ingen s√•dan anv√§ndare');
          if(users[user].pw !== hashPw(pw)) return alert('Fel l√∂senord');
          saveSession(user); onLogin(user);
        }
        return (
          <form onSubmit={submit} className="flex flex-col gap-3">
            <input className="p-2 bg-[#071225] rounded" placeholder="Anv√§ndarnamn" value={user} onChange={e=>setUser(e.target.value)}/>
            <input className="p-2 bg-[#071225] rounded" placeholder="L√∂senord" type="password" value={pw} onChange={e=>setPw(e.target.value)}/>
            <div className="flex gap-2">
              <button className="flex-1 bg-[--accent] py-2 rounded">Logga in</button>
              <button type="button" onClick={()=>{
                // quick demo account
                const name = 'user' + Math.floor(Math.random()*9000+1000);
                const users = loadUsers(); users[name] = { pw: hashPw('demo'), created: Date.now() }; saveUsers(users);
                saveSession(name); onLogin(name);
              }} className="px-3 py-2 bg-white/6 rounded">Demo</button>
            </div>
          </form>
        );
      }

      function RegisterForm({ onRegister }){
        const [u,setU]=useState(''); const [p,setP]=useState(''); const [p2,setP2]=useState('');
        function submit(e){ e.preventDefault();
          if(!u.trim()) return alert('Anv√§ndarnamn kr√§vs');
          if(p.length < 4) return alert('L√∂senord minst 4 tecken');
          if(p !== p2) return alert('L√∂senorden matchar inte');
          const users = loadUsers();
          if(users[u]) return alert('Anv√§ndarnamn upptaget');
          users[u] = { pw: hashPw(p), created: Date.now() };
          saveUsers(users);
          saveSession(u);
          onRegister(u);
        }
        return (
          <form onSubmit={submit} className="flex flex-col gap-3">
            <input className="p-2 bg-[#071225] rounded" placeholder="V√§lj anv√§ndarnamn" value={u} onChange={e=>setU(e.target.value)}/>
            <input className="p-2 bg-[#071225] rounded" placeholder="L√∂senord" type="password" value={p} onChange={e=>setP(e.target.value)}/>
            <input className="p-2 bg-[#071225] rounded" placeholder="Bekr√§fta l√∂senord" type="password" value={p2} onChange={e=>setP2(e.target.value)}/>
            <button className="bg-[--accent] py-2 rounded">Skapa konto</button>
          </form>
        );
      }

      /*** Main App ***/
      function App(){
        const [me, setMe] = useState(loadSession());
        const [data, setData] = useState(loadData());
        const [activeServer, setActiveServer] = useState(null);
        const [activeCategory, setActiveCategory] = useState(null);
        const [activeChannel, setActiveChannel] = useState(null); // channel id
        const [view, setView] = useState('server'); // 'server' or 'dm'
        const [activeDM, setActiveDM] = useState(null); // dmKey
        const [showAdmin, setShowAdmin] = useState(false);
        const [showInviteFor, setShowInviteFor] = useState(null);
        const [showSettingsFor, setShowSettingsFor] = useState(null);
        const [typingTick, setTypingTick] = useState(0);

        // keep session / data in sync across tabs
        useEffect(()=> {
          function onStorage(e){
            if(e.key === DATA_KEY) setData(loadData());
            if(e.key === SESSION_KEY) setMe(loadSession());
          }
          window.addEventListener('storage', onStorage);
          return ()=>window.removeEventListener('storage', onStorage);
        },[]);

        useEffect(()=> { saveData(data); }, [data]);

        // Admin keyboard shortcut: Ctrl + Alt + Tab
        useEffect(()=> {
          function handler(e){
            if(e.ctrlKey && e.altKey && e.key === 'Tab'){
              const pw = prompt('Admin-l√∂senord:');
              if(pw === ADMIN_PW) setShowAdmin(true);
              else alert('Fel l√∂senord');
            }
          }
          window.addEventListener('keydown', handler);
          return ()=>window.removeEventListener('keydown', handler);
        },[]);

        // typing indicator cleanup tick
        useEffect(()=>{
          const t = setInterval(()=> setTypingTick(t=>t+1), 2000);
          return ()=>clearInterval(t);
        },[]);

        // if not logged in -> show auth
        if(!me) return <Auth onLogin={(u)=>{ setMe(u); /* ensure user exists in users list */ const us = loadUsers(); if(!us[u]){ us[u] = { pw: hashPw('demo'), created: Date.now() }; saveUsers(us); } /* ensure member membership not auto-added to servers */ }} />;

        // helper getters
        function getServer(sid){ return data.servers[sid] || null; }
        function getChannelById(sid, cid){
          const s = getServer(sid);
          if(!s) return null;
          for(const catId of Object.keys(s.categories || {})){
            const cat = s.categories[catId];
            const ch = (cat.channels || []).find(c=>c.id===cid);
            if(ch) return ch;
          }
          return null;
        }

        // create server
        function createServer(){
          const name = prompt('Namn p√• server:');
          if(!name) return;
          const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Math.floor(Math.random()*9000);
          const copy = JSON.parse(JSON.stringify(data));
          copy.servers[id] = {
            id, name, icon: name[0].toUpperCase(),
            owner: me,
            roles: {
              Owner: { permissions: { manage_server:true, manage_roles:true, manage_channels:true, delete_messages:true, create_messages:true, invite_members:true } },
              Admin: { permissions: { manage_server:false, manage_roles:false, manage_channels:true, delete_messages:true, create_messages:true, invite_members:true } },
              Mod: { permissions: { manage_server:false, manage_roles:false, manage_channels:false, delete_messages:true, create_messages:true, invite_members:false } },
              Member: { permissions: { manage_server:false, manage_roles:false, manage_channels:false, delete_messages:false, create_messages:true, invite_members:false } }
            },
            members: [me],
            memberRoles: { [me]:'Owner' },
            categories: {}, // categories map
            invites: {}
          };
          // create default category & channel
          const catId = uid('cat');
          copy.servers[id].categories[catId] = { id:catId, name:'TEXT CHANNELS', collapsed:false, channels: [ { id:'general', name:'general', type:'text', messages:[], pins:[], voiceMembers:[] } ] };
          setData(copy);
          setActiveServer(id);
          setActiveCategory(catId);
          setActiveChannel('general');
        }

        // create category
        function createCategory(){
          if(!activeServer) return alert('V√§lj en server');
          const s = getServer(activeServer);
          if(!(s.owner === me || s.roles?.[s.memberRoles?.[me]]?.permissions?.manage_channels)) return alert('Ingen r√§tt att skapa kategori');
          const name = prompt('Namn p√• kategori:') || 'Ny kategori';
          const copy = JSON.parse(JSON.stringify(data));
          const catId = uid('cat');
          copy.servers[activeServer].categories[catId] = { id:catId, name, collapsed:false, channels: [] };
          setData(copy);
        }

        // create channel (text or voice)
        function createChannel(catId){
          if(!activeServer) return alert('V√§lj en server');
          const s = getServer(activeServer);
          if(!(s.owner === me || s.roles?.[s.memberRoles?.[me]]?.permissions?.manage_channels)) return alert('Ingen r√§tt att skapa kanal');
          const name = prompt('Namn p√• kanal (utan mellanslag):');
          if(!name) return;
          const type = prompt('Typ (text/voice):', 'text') || 'text';
          const copy = JSON.parse(JSON.stringify(data));
          const ch = { id: name, name, type: type === 'voice' ? 'voice' : 'text', messages:[], pins:[], voiceMembers: [] };
          copy.servers[activeServer].categories[catId].channels.push(ch);
          setData(copy);
        }

        // invite user
        function inviteToServer(serverId){
          const allUsers = Object.keys(loadUsers());
          const sel = prompt('Ange anv√§ndarnamn att bjuda in:\n(Se registrerade anv√§ndare i console eller implementera invite dialog)');
          if(!sel) return;
          const users = loadUsers();
          if(!users[sel]) return alert('Ingen s√•dan registrerad anv√§ndare');
          const copy = JSON.parse(JSON.stringify(data));
          const srv = copy.servers[serverId];
          if(srv.members.includes(sel)) return alert('Anv√§ndaren √§r redan medlem');
          srv.members.push(sel);
          srv.memberRoles[sel] = 'Member';
          saveData(copy); setData(copy);
          alert(sel + ' inbjuden');
        }

        // join voice channel (simulated)
        function joinVoice(catId, channelId){
          const copy = JSON.parse(JSON.stringify(data));
          const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
          if(!ch || ch.type !== 'voice') return;
          if(!ch.voiceMembers.includes(me)) ch.voiceMembers.push(me);
          setData(copy);
        }
        function leaveVoice(catId, channelId){
          const copy = JSON.parse(JSON.stringify(data));
          const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
          if(!ch || ch.type !== 'voice') return;
          ch.voiceMembers = ch.voiceMembers.filter(x=>x!==me);
          setData(copy);
        }

        // send text message to channel
        function sendChannelMessage(catId, channelId, text){
          const s = getServer(activeServer);
          if(!s) return;
          const role = s.memberRoles?.[me] || 'Member';
          const can = s.roles?.[role]?.permissions?.create_messages;
          if(!can) return alert('Ingen r√§tt att skriva i den h√§r kanalen');
          const copy = JSON.parse(JSON.stringify(data));
          const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
          if(!ch) return;
          ch.messages.push({ id: uid('m'), user: me, text, ts: new Date().toISOString(), reactions:{}, pinned:false });
          setData(copy);
        }

        // delete message
        function deleteChannelMessage(catId, channelId, msgId){
          const s = getServer(activeServer);
          if(!s) return;
          const role = s.memberRoles?.[me] || 'Member';
          const canDelete = (s.owner === me) || s.roles?.[role]?.permissions?.delete_messages;
          const copy = JSON.parse(JSON.stringify(data));
          const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
          if(!ch) return;
          const idx = ch.messages.findIndex(m=>m.id===msgId);
          if(idx === -1) return;
          if(ch.messages[idx].user !== me && !canDelete) return alert('Ingen r√§tt att radera det h√§r meddelandet');
          ch.messages.splice(idx,1);
          setData(copy);
        }

        // pin/unpin
        function togglePin(catId, channelId, msgId){
          const s = getServer(activeServer);
          if(!s) return;
          const copy = JSON.parse(JSON.stringify(data));
          const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
          if(!ch) return;
          const m = ch.messages.find(x=>x.id===msgId);
          if(!m) return;
          m.pinned = !m.pinned;
          setData(copy);
        }

        // react
        function reactChannelMessage(catId, channelId, msgId, emoji){
          const copy = JSON.parse(JSON.stringify(data));
          const ch = copy.servers[activeServer].categories[catId].channels.find(c=>c.id===channelId);
          const m = ch.messages.find(x=>x.id===msgId);
          m.reactions = m.reactions || {};
          m.reactions[emoji] = (m.reactions[emoji] || 0) + 1;
          setData(copy);
        }

        // typing indicator: on keydown set data.typing[roomKey] = { user, ts }
        function setTyping(roomKey){
          const copy = JSON.parse(JSON.stringify(data));
          copy.typing = copy.typing || {};
          copy.typing[roomKey] = { user: me, ts: Date.now() };
          setData(copy);
        }
        function typingUsers(roomKey){
          const t = (data.typing && data.typing[roomKey]) ? data.typing[roomKey] : null;
          if(!t) return null;
          if(Date.now() - t.ts > 5000) return null; // stale
          return t.user;
        }

        // DM functions
        function openDMWith(user){
          const key = dmKey(me, user);
          const copy = JSON.parse(JSON.stringify(data));
          if(!copy.dms) copy.dms = {};
          if(!copy.dms[key]) copy.dms[key] = [];
          setData(copy);
          setActiveDM(key);
          setView('dm');
        }
        function sendDMMessage(key, text){
          const copy = JSON.parse(JSON.stringify(data));
          copy.dms[key] = copy.dms[key] || [];
          copy.dms[key].push({ id: uid('m'), user: me, text, ts: new Date().toISOString(), reactions:{} });
          setData(copy);
        }
        function deleteDMMessage(key,msgId){
          const copy = JSON.parse(JSON.stringify(data));
          copy.dms[key] = (copy.dms[key] || []).filter(m=>m.id!==msgId);
          setData(copy);
        }
        function reactDM(key,msgId,emoji){
          const copy = JSON.parse(JSON.stringify(data));
          const m = copy.dms[key].find(x=>x.id===msgId);
          m.reactions = m.reactions || {};
          m.reactions[emoji] = (m.reactions[emoji] || 0) + 1;
          setData(copy);
        }

        // server settings change
        function openServerSettings(serverId){
          setShowSettingsFor(serverId);
        }
        function saveServerSettings(serverId, newName, newIcon){
          const copy = JSON.parse(JSON.stringify(data));
          copy.servers[serverId].name = newName;
          copy.servers[serverId].icon = newIcon;
          setData(copy);
          setShowSettingsFor(null);
        }

        // delete server
        function deleteServer(serverId){
          const s = getServer(serverId);
          if(!s) return;
          if(s.owner !== me && !s.roles?.[s.memberRoles?.[me]]?.permissions?.manage_server) return alert('Ingen r√§tt att ta bort servern');
          if(!confirm('Radera server '+s.name+'?')) return;
          const copy = JSON.parse(JSON.stringify(data));
          delete copy.servers[serverId];
          setData(copy);
          setActiveServer(null);
          setActiveCategory(null);
          setActiveChannel(null);
        }

        // UI pieces
        function ServerList(){
          return (
            <div className="w-20 bg-[#071127] p-2 flex flex-col gap-3 items-center border-r border-black/20">
              <button onClick={()=>{ setActiveServer(null); setView('dm'); setActiveDM(null); }} title="Hem (DMs)" className={`w-12 h-12 rounded-full bg-[#0e1420] flex items-center justify-center`}>üè†</button>
              {Object.values(data.servers).map(s=>(
                <div key={s.id}>
                  <button title={s.name} onClick={()=>{ setActiveServer(s.id); setView('server'); setActiveDM(null); /* choose first category/channel */ const catKeys = Object.keys(s.categories||{}); if(catKeys.length){ setActiveCategory(catKeys[0]); const ch = s.categories[catKeys[0]].channels[0]; if(ch) setActiveChannel(ch.id); }} } className={`server-icon bg-[#0e1420] ${activeServer===s.id ? 'ring-2 ring-white/10' : 'hover:scale-105'}`}>{s.icon || s.name[0]}</button>
                </div>
              ))}
              <div className="mt-auto">
                <button onClick={createServer} className="w-12 h-12 rounded-full bg-white/6 flex items-center justify-center">+</button>
              </div>
            </div>
          );
        }

        // Channels + categories panel
        function ChannelsPanel(){
          if(!activeServer) return (
            <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex items-center">
              <div className="text-sm text-[#94a3b8]">V√§lj en server eller g√• till Hem (DMs)</div>
            </div>
          );
          const s = getServer(activeServer);
          return (
            <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex flex-col">
              <div className="flex justify-between items-center mb-3">
                <div>
                  <div className="font-bold">{s.name}</div>
                  <div className="text-xs text-[#94a3b8]">{s.members.length} medlemmar</div>
                </div>
                <div className="flex gap-2">
                  <button onClick={()=>openServerSettings(s.id)} className="px-2 py-1 rounded bg-white/6">‚öôÔ∏è</button>
                  <button onClick={()=>deleteServer(s.id)} className="px-2 py-1 rounded bg-red-600/30">Radera</button>
                </div>
              </div>

              <div className="mb-2">
                <div className="text-xs text-[#94a3b8]">Kategorier</div>
                <div className="flex flex-col gap-1">
                  {Object.values(s.categories || {}).map(cat => (
                    <div key={cat.id}>
                      <div className="category-header flex items-center justify-between">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={()=>{ const copy = JSON.parse(JSON.stringify(data)); copy.servers[activeServer].categories[cat.id].collapsed = !copy.servers[activeServer].categories[cat.id].collapsed; setData(copy); }}>
                          <span>{cat.collapsed ? '‚ñ∏' : '‚ñæ'}</span>
                          <span className="text-xs">{cat.name}</span>
                        </div>
                        <div className="flex gap-1">
                          <button onClick={()=>{ if(confirm('Skapa kanal i '+cat.name+'?')) createChannel(cat.id); }} className="text-xs bg-white/6 px-2 py-1 rounded">+ kanal</button>
                        </div>
                      </div>
                      {!cat.collapsed && (
                        <div className="pl-3">
                          {cat.channels.map(ch => (
                            <div key={ch.id} onClick={()=>{ setActiveCategory(cat.id); setActiveChannel(ch.id); setView('server'); }} className={`px-2 py-1 rounded cursor-pointer ${activeChannel===ch.id ? 'bg-white/6' : 'hover:bg-white/5'}`}>
                              {ch.type === 'voice' ? 'üîä ' : '# '}{ch.name}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
                <div className="mt-2">
                  <button onClick={createCategory} className="w-full py-2 rounded bg-white/6">+ Ny kategori</button>
                </div>
              </div>
            </div>
          );
        }

        // Members panel (right)
        function MembersPanel(){
          if(!activeServer) return (
            <div className="w-64 bg-[#071428] p-3 border-l border-black/20">
              <div className="text-sm text-[#94a3b8]">Hem / DMs</div>
            </div>
          );
          const s = getServer(activeServer);
          return (
            <div className="w-64 bg-[#071428] p-3 border-l border-black/20 flex flex-col">
              <div className="flex justify-between items-center mb-2">
                <div className="font-semibold">Medlemmar</div>
                <div className="text-xs text-[#94a3b8]">Invites</div>
              </div>
              <div className="flex-1 overflow-auto scrollbar-thin">
                {s.members.map(m => (
                  <div key={m} className="flex items-center justify-between px-2 py-1 hover:bg-white/5 rounded">
                    <div className="flex items-center gap-2">
                      <div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{m[0]}</div>
                      <div>
                        <div className="font-medium">{m}</div>
                        <div className="text-xs text-[#94a3b8]">{s.memberRoles?.[m] || 'Member'}</div>
                      </div>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={()=>openDMWith(m)} className="text-xs bg-white/6 px-2 py-1 rounded">DM</button>
                      {(s.owner === me || s.roles?.[s.memberRoles?.[me]]?.permissions?.manage_roles) && <button onClick={()=>{ const role = prompt('Ange roll (Owner/Admin/Mod/Member):'); if(role){ const copy = JSON.parse(JSON.stringify(data)); copy.servers[activeServer].memberRoles[m] = role; setData(copy); } }} className="text-xs bg-white/6 px-2 py-1 rounded">Roll</button>}
                      {(s.owner === me || s.roles?.[s.memberRoles?.[me]]?.permissions?.invite_members) && <button onClick={()=>inviteToServer(activeServer)} className="text-xs bg-[--accent] px-2 py-1 rounded">Bjud in</button>}
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-3">
                <div className="text-xs text-[#94a3b8] mb-1">Din anv√§ndare</div>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="w-10 h-10 rounded-full bg-[#1e2a3a] flex items-center justify-center">{me[0]}</div>
                    <div>
                      <div className="font-medium">{me}</div>
                      <div className="text-xs text-[#94a3b8]">Status: Online</div>
                    </div>
                  </div>
                  <div>
                    <button onClick={()=>{ saveSession(null); location.reload(); }} className="text-xs bg-red-600/30 px-2 py-1 rounded">Logga ut</button>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        // Central view: channel or DM
        function CenterPanel(){
          if(view === 'dm'){
            const msgs = (data.dms && data.dms[activeDM]) ? data.dms[activeDM] : [];
            const other = activeDM ? activeDM.split('|').find(x=>x!==me) : null;
            return (
              <div className="flex-1 flex flex-col">
                <div className="px-6 py-4 border-b border-black/30 flex items-center justify-between">
                  <div>
                    <div className="font-semibold">DM ‚Äî {other}</div>
                    <div className="text-xs text-[#94a3b8]">Privat</div>
                  </div>
                </div>
                <div className="flex-1 overflow-auto p-6 scrollbar-thin">
                  <div className="max-w-3xl flex flex-col gap-4">
                    {msgs.length === 0 && <div className="text-[#94a3b8]">Inga meddelanden √§n...</div>}
                    {msgs.map(m => (
                      <div key={m.id} className="flex gap-3">
                        <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{m.user[0]}</div>
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <div className="font-medium">{m.user}</div>
                            <div className="text-xs text-[#94a3b8]">{new Date(m.ts).toLocaleTimeString()}</div>
                            <div className="ml-auto">
                              {m.user === me && <button onClick={()=>{ if(confirm('Radera?')) deleteDMMessage(activeDM, m.id); }} className="text-xs text-red-400">Radera</button>}
                            </div>
                          </div>
                          <div className="mt-1">{m.text}</div>
                          <div className="mt-1 flex gap-2">
                            {Object.entries(m.reactions || {}).map(([e,c]) => <div key={e} className="bg-white/10 px-2 rounded cursor-pointer" onClick={()=>reactDM(activeDM, m.id, e)}>{e} {c}</div>)}
                            <button onClick={()=>{ const e = prompt('Emoji:'); if(e) reactDM(activeDM, m.id, e); }} className="text-xs text-[#94a3b8]">+ Reagera</button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                <Composer onSend={(t)=>sendDMMessage(activeDM,t)} onTyping={()=>{ const key = 'dm|' + activeDM; const copy = JSON.parse(JSON.stringify(data)); copy.typing = copy.typing || {}; copy.typing[key] = { user: me, ts: Date.now() }; setData(copy); }} typing={typingUsers('dm|' + activeDM)} />
              </div>
            );
          }

          // server view
          if(!activeServer) return (
            <div className="flex-1 flex items-center justify-center text-[#94a3b8]">V√§lj en server eller starta en ny.</div>
          );
          const s = getServer(activeServer);
          if(!activeCategory || !activeChannel) return (
            <div className="flex-1 flex items-center justify-center text-[#94a3b8]">V√§lj en kanal.</div>
          );
          const ch = getChannelById(activeServer, activeChannel);
          if(!ch) return <div className="flex-1 flex items-center justify-center">Kanal inte hittad</div>;
          if(ch.type === 'voice'){
            return (
              <div className="flex-1 flex flex-col">
                <div className="px-6 py-4 border-b border-black/30 flex items-center justify-between">
                  <div>
                    <div className="font-semibold">üîä {ch.name}</div>
                    <div className="text-xs text-[#94a3b8]">R√∂stkanal ‚Äî {ch.voiceMembers.length} online</div>
                  </div>
                  <div>
                    {ch.voiceMembers.includes(me) ? <button onClick={()=>leaveVoice(activeCategory, ch.id)} className="px-3 py-1 rounded bg-red-600/30">L√§mna</button> : <button onClick={()=>joinVoice(activeCategory, ch.id)} className="px-3 py-1 rounded bg-[--accent]">G√• med</button>}
                  </div>
                </div>
                <div className="flex-1 overflow-auto p-6">
                  <div className="max-w-3xl">
                    <div className="font-medium mb-3">Deltagare</div>
                    {ch.voiceMembers.length === 0 && <div className="text-[#94a3b8]">Ingen i kanalen</div>}
                    {ch.voiceMembers.map(u => <div key={u} className="flex items-center gap-3 mb-2"><div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{u[0]}</div><div>{u} {u===me && <span className="text-xs text-[#94a3b8]"> (du)</span>}</div></div>)}
                    <div className="mt-4 text-xs text-[#94a3b8]">Observera: r√∂st √§r simulerat ‚Äî ingen faktiskt ljud√∂verf√∂ring.</div>
                  </div>
                </div>
              </div>
            );
          }

          // text channel
          return (
            <div className="flex-1 flex flex-col">
              <div className="px-6 py-4 border-b border-black/30 flex items-center justify-between">
                <div>
                  <div className="font-semibold">#{ch.name}</div>
                  <div className="text-xs text-[#94a3b8]">{s.name}</div>
                </div>
                <div className="text-xs text-[#94a3b8]">{typingUsers(activeServer + '|' + activeChannel) ? `${typingUsers(activeServer + '|' + activeChannel)} skriver...` : ''}</div>
              </div>

              <div className="flex-1 overflow-auto p-6 scrollbar-thin">
                <div className="max-w-3xl flex flex-col gap-4">
                  {ch.messages.length === 0 && <div className="text-[#94a3b8]">Inga meddelanden √§n</div>}
                  {ch.messages.map(m => (
                    <div key={m.id} className="flex gap-3">
                      <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{m.user[0]}</div>
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                          <div className="font-medium">{m.user}</div>
                          <div className="text-xs text-[#94a3b8]">{new Date(m.ts).toLocaleTimeString()}</div>
                          <div className="ml-auto flex gap-2">
                            <button onClick={()=>{ togglePin(activeCategory, ch.id, m.id); }} className="text-xs bg-white/6 px-2 py-1 rounded">{m.pinned ? 'Unpin' : 'Pin'}</button>
                            { (m.user === me || s.owner === me || s.roles?.[s.memberRoles?.[me]]?.permissions?.delete_messages) && <button onClick={()=>{ if(confirm('Radera meddelande?')) deleteChannelMessage(activeCategory, ch.id, m.id); }} className="text-xs text-red-400">Radera</button> }
                          </div>
                        </div>
                        <div className="mt-1">{m.text}</div>
                        <div className="mt-1 flex gap-2 items-center">
                          {Object.entries(m.reactions || {}).map(([e,c]) => <div key={e} className="bg-white/10 px-2 rounded cursor-pointer" onClick={()=>reactChannelMessage(activeCategory, ch.id, m.id, e)}>{e} {c}</div>)}
                          <button onClick={()=>{ const e = prompt('Emoji:'); if(e) reactChannelMessage(activeCategory, ch.id, m.id, e); }} className="text-xs text-[#94a3b8]">+ Reagera</button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <Composer onSend={(t)=>{ sendChannelMessage(activeCategory, ch.id, t); }} onTyping={()=>{ const key = activeServer + '|' + activeChannel; const copy = JSON.parse(JSON.stringify(data)); copy.typing = copy.typing || {}; copy.typing[key] = { user: me, ts: Date.now() }; setData(copy); }} typing={typingUsers(activeServer + '|' + activeChannel)} />
            </div>
          );
        }

        // composer component
        function Composer({ onSend, onTyping, typing }){
          const ref = useRef();
          function send(){ const v = ref.current.value.trim(); if(!v) return; onSend(v); ref.current.value=''; }
          return (
            <div className="p-4 border-t border-black/20">
              <div className="max-w-3xl mx-auto flex gap-2">
                <textarea ref={ref} rows="2" placeholder="Skriv ett meddelande..." className="flex-1 bg-[#071225] rounded px-4 py-2 resize-none" onKeyDown={(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } else { onTyping && onTyping(); } }}></textarea>
                <button onClick={send} className="bg-[--accent] px-4 py-2 rounded">Skicka</button>
              </div>
            </div>
          );
        }

        // settings modal
        function ServerSettingsModal({ serverId, onClose }){
          const s = getServer(serverId);
          const [name, setName] = useState(s.name);
          const [icon, setIcon] = useState(s.icon || s.name[0]);
          function save(){ saveServerSettings(serverId, name, icon); }
          function manageRoles(){
            const role = prompt('Rollens namn att √§ndra (Owner/Admin/Mod/Member):');
            if(!role) return;
            const perms = s.roles[role].permissions;
            const keys = Object.keys(perms);
            const updated = {};
            keys.forEach(k => {
              const val = confirm('S√§tt permission "'+k+'" till true? (OK = true, Avbryt = false)');
              updated[k] = val;
            });
            const copy = JSON.parse(JSON.stringify(data));
            copy.servers[serverId].roles[role].permissions = updated;
            setData(copy);
            alert('Sparat');
          }
          return (
            <div className="modal-backdrop">
              <div className="bg-[#0b1220] rounded p-4 w-2/3 max-w-2xl">
                <div className="flex justify-between items-center mb-3">
                  <div className="font-semibold">Serverinst√§llningar ‚Äî {s.name}</div>
                  <div className="flex gap-2">
                    <button onClick={manageRoles} className="px-2 py-1 bg-white/6 rounded">√Ñndra roller</button>
                    <button onClick={onClose} className="px-2 py-1 bg-red-600/30 rounded">St√§ng</button>
                  </div>
                </div>

                <div className="mb-3">
                  <label className="text-xs text-[#94a3b8]">Namn</label>
                  <input value={name} onChange={e=>setName(e.target.value)} className="w-full p-2 bg-[#071225] rounded mt-1"/>
                </div>
                <div className="mb-3">
                  <label className="text-xs text-[#94a3b8]">Icon</label>
                  <input value={icon} onChange={e=>setIcon(e.target.value)} className="w-full p-2 bg-[#071225] rounded mt-1"/>
                </div>

                <div className="flex justify-end gap-2">
                  <button onClick={onClose} className="px-3 py-2 bg-white/6 rounded">Avbryt</button>
                  <button onClick={save} className="px-3 py-2 bg-[--accent] rounded">Spara</button>
                </div>
              </div>
            </div>
          );
        }

        // Invite modal (select from registered users)
        function InviteModal({ serverId, onClose }){
          const [all, setAll] = useState(Object.keys(loadUsers()));
          function invite(u){
            if(!confirm('Bjud in '+u+'?')) return;
            const copy = JSON.parse(JSON.stringify(data));
            const s = copy.servers[serverId];
            if(!s.members.includes(u)){ s.members.push(u); s.memberRoles[u] = 'Member'; setData(copy); alert(u+' inbjuden'); }
            else alert('Redan medlem');
            onClose();
          }
          return (
            <div className="modal-backdrop">
              <div className="bg-[#0b1220] rounded p-4 w-96">
                <div className="flex justify-between items-center mb-2">
                  <div className="font-semibold">Bjud in anv√§ndare</div>
                  <button onClick={onClose} className="px-2 py-1 bg-white/6 rounded">St√§ng</button>
                </div>
                <div className="max-h-72 overflow-auto scrollbar-thin">
                  {all.map(u=>(
                    <div key={u} className="flex items-center justify-between px-2 py-1 hover:bg-white/5 rounded">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{u[0]}</div>
                        <div>
                          <div className="font-medium">{u}</div>
                          <div className="text-xs text-[#94a3b8]">Registrerad</div>
                        </div>
                      </div>
                      <div>
                        <button onClick={()=>invite(u)} className="px-2 py-1 bg-[--accent] rounded">Bjud in</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="flex h-screen">
            <ServerList />
            <ChannelsPanel />
            <CenterPanel />
            <MembersPanel />
            { showAdmin && <AdminPanel onClose={()=>setShowAdmin(false)} /> }
            { showInviteFor && <InviteModal serverId={showInviteFor} onClose={()=>setShowInviteFor(null)} /> }
            { showSettingsFor && <ServerSettingsModal serverId={showSettingsFor} onClose={()=>setShowSettingsFor(null)} /> }
          </div>
        );
      }

      /*** Render ***/
      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>

