<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Discord-klon ‚Äî Servrar, Roller & Invite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{
        --bg:#0f1724;
        --panel:#0b1220;
        --muted:#94a3b8;
        --accent:#5865f2;
      }
      body { background: linear-gradient(180deg,var(--bg),#071027); }
      .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
      .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
      .server-icon { width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700; }
      .dot-unread{width:8px;height:8px;border-radius:50%;background:#f43f5e}
      .modal-backdrop{ background: rgba(0,0,0,0.6); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
    </style>
  </head>
  <body class="min-h-screen text-sm text-white">
    <div id="root"></div>

    <!-- React + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      /****************************************
       * Storage keys, helpers & defaults
       ****************************************/
      const USERS_KEY = 'discord_clone_users_v2';
      const DATA_KEY = 'discord_clone_data_v2';
      const SESSION_KEY = 'discord_clone_session_v2';

      function loadUsers(){
        try { return JSON.parse(localStorage.getItem(USERS_KEY)) || {}; }
        catch(e){ return {}; }
      }
      function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }

      function loadData(){
        try { return JSON.parse(localStorage.getItem(DATA_KEY)) || defaultData(); }
        catch(e){ return defaultData(); }
      }
      function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }

      function loadSession(){ return localStorage.getItem(SESSION_KEY); }
      function saveSession(username){ if(username) localStorage.setItem(SESSION_KEY, username); else localStorage.removeItem(SESSION_KEY); }

      function hashPw(pw){ return btoa(pw); } // demo-only

      function defaultData(){
        // default roles include invite_members permission now
        return {
          servers: {
            home: {
              id: 'home',
              name: 'Hem',
              icon: 'üè†',
              owner: 'Anna',
              roles: {
                Owner: { permissions: { manage_server:true, manage_roles:true, manage_channels:true, delete_messages:true, create_messages:true, invite_members:true } },
                Admin: { permissions: { manage_server:false, manage_roles:false, manage_channels:true, delete_messages:true, create_messages:true, invite_members:true } },
                Mod: { permissions: { manage_server:false, manage_roles:false, manage_channels:false, delete_messages:true, create_messages:true, invite_members:false } },
                Member: { permissions: { manage_server:false, manage_roles:false, manage_channels:false, delete_messages:false, create_messages:true, invite_members:false } }
              },
              members: ['Anna','Bj√∂rn','Cara'],
              memberRoles: { 'Anna':'Owner', 'Bj√∂rn':'Admin', 'Cara':'Member' },
              channels: {
                general: { id:'general', name:'general', messages: [
                  { id:'m1', user:'Anna', text:'V√§lkommen till Hem-servern!', ts: new Date().toISOString() }
                ] }
              },
              invites: [] // store pending invites (username strings) optionally
            }
          }
        };
      }

      /****************************************
       * Permission helpers
       ****************************************/
      function getRoleForUser(server, username){
        if(!server) return null;
        return server.memberRoles?.[username] || 'Member';
      }
      function hasPermission(server, username, perm){
        if(!server) return false;
        const role = getRoleForUser(server, username);
        const roleDef = server.roles?.[role];
        return !!(roleDef && roleDef.permissions && roleDef.permissions[perm]);
      }

      /****************************************
       * Auth UI: Register / Login
       ****************************************/
      function Auth({ onLogin }) {
        const [tab, setTab] = useState('login'); // 'login'|'register'
        return (
          <div className="flex items-center justify-center h-screen">
            <div className="w-96">
              <div className="bg-[#0f1724] p-6 rounded-2xl shadow-xl">
                <div className="flex justify-between items-center mb-4">
                  <h1 className="text-xl font-semibold">Discord-klon</h1>
                  <div className="text-xs text-[#94a3b8]">Demo ‚Äî localStorage</div>
                </div>

                <div className="mb-4">
                  <div className="flex gap-2">
                    <button onClick={()=>setTab('login')} className={`flex-1 py-2 rounded ${tab==='login'?'bg-white/6':''}`}>Logga in</button>
                    <button onClick={()=>setTab('register')} className={`flex-1 py-2 rounded ${tab==='register'?'bg-white/6':''}`}>Skapa konto</button>
                  </div>
                </div>

                {tab==='login' ? <LoginForm onLogin={onLogin} /> : <RegisterForm onRegister={onLogin} />}

                <div className="text-xs text-[#94a3b8] mt-4">Tip: Anv√§nd "Logga in med Google" f√∂r att snabbt skapa demo-konton lokalt.</div>
              </div>
            </div>
          </div>
        );
      }

      function LoginForm({ onLogin }){
        const [user, setUser] = useState('');
        const [pw, setPw] = useState('');
        function submit(e){
          e.preventDefault();
          const users = loadUsers();
          if(!users[user]) { alert('Ingen s√•dan anv√§ndare'); return; }
          if(users[user].pw !== hashPw(pw)) { alert('Fel l√∂senord'); return; }
          saveSession(user);
          onLogin(user);
        }
        return (
          <form onSubmit={submit} className="flex flex-col gap-3">
            <input value={user} onChange={e=>setUser(e.target.value)} placeholder="Anv√§ndarnamn" className="p-2 bg-[#071225] rounded" />
            <input value={pw} onChange={e=>setPw(e.target.value)} placeholder="L√∂senord" type="password" className="p-2 bg-[#071225] rounded" />
            <button className="mt-2 bg-[--accent] py-2 rounded">Logga in</button>

            <button type="button" onClick={()=>{
              // Fake Google login: create account if not exists
              const g = 'google_' + Math.floor(Math.random()*100000);
              const users = loadUsers();
              if(!users[g]) { users[g] = { pw: hashPw('google-demo'), created: Date.now() }; saveUsers(users); }
              saveSession(g); onLogin(g);
            }} className="mt-2 text-xs bg-white/6 py-2 rounded">Logga in med Google (demo)</button>
          </form>
        );
      }

      function RegisterForm({ onRegister }){
        const [user,setUser] = useState('');
        const [pw,setPw] = useState('');
        const [pw2,setPw2] = useState('');
        function submit(e){
          e.preventDefault();
          if(!user.trim()) { alert('Anv√§ndarnamn kr√§vs'); return; }
          if(pw.length < 4) { alert('L√∂senord minst 4 tecken'); return; }
          if(pw !== pw2) { alert('L√∂senorden matchar inte'); return; }
          const users = loadUsers();
          if(users[user]) { alert('Anv√§ndarnamn upptaget'); return; }
          users[user] = { pw: hashPw(pw), created: Date.now() };
          saveUsers(users);
          // ensure new user is included in existing servers as Member (optional)
          const data = loadData();
          Object.values(data.servers).forEach(s=>{
            if(!s.members.includes(user)) { s.members.push(user); s.memberRoles[user] = 'Member'; }
          });
          saveData(data);
          saveUsers(users);
          saveSession(user);
          onRegister(user);
        }
        return (
          <form onSubmit={submit} className="flex flex-col gap-3">
            <input value={user} onChange={e=>setUser(e.target.value)} placeholder="V√§lj anv√§ndarnamn" className="p-2 bg-[#071225] rounded" />
            <input value={pw} onChange={e=>setPw(e.target.value)} placeholder="L√∂senord" type="password" className="p-2 bg-[#071225] rounded" />
            <input value={pw2} onChange={e=>setPw2(e.target.value)} placeholder="Bekr√§fta l√∂senord" type="password" className="p-2 bg-[#071225] rounded" />
            <button className="mt-2 bg-[--accent] py-2 rounded">Skapa konto</button>
          </form>
        );
      }

      /****************************************
       * UI: Server Sidebar, Channels, Members
       ****************************************/
      function ServerSidebar({ servers, activeServer, setActiveServer, onCreateServer }){
        return (
          <div className="w-20 bg-[#071127] p-2 flex flex-col gap-3 items-center border-r border-black/20">
            <button onClick={()=>setActiveServer(null)} title="Hem (DMs)" className={`w-12 h-12 rounded-full bg-[#0e1420] flex items-center justify-center`}>üè†</button>
            {Object.values(servers).map(s=>(
              <div key={s.id} className="relative">
                <button onClick={()=>setActiveServer(s.id)} title={s.name} className={`server-icon bg-[#0e1420] ${activeServer===s.id ? 'ring-2 ring-white/10' : 'hover:scale-105'}`}>
                  {s.icon || s.name[0]}
                </button>
                {/* unread marker could go here */}
              </div>
            ))}
            <div className="mt-auto">
              <button onClick={onCreateServer} className="w-12 h-12 rounded-full bg-white/6 flex items-center justify-center">+</button>
            </div>
          </div>
        );
      }

      function ChannelsPanel({ server, activeChannel, setActiveChannel, onCreateChannel, me }){
        if(!server) return (
          <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex items-center">
            <div className="text-sm text-[#94a3b8]">V√§lj en server</div>
          </div>
        );
        return (
          <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex flex-col">
            <div className="flex justify-between items-center mb-3">
              <div>
                <div className="font-bold">{server.name}</div>
                <div className="text-xs text-[#94a3b8]">{server.members.length} medlemmar</div>
              </div>
              <div className="flex gap-2">
                <button title="Serverinst√§llningar" onClick={()=>document.dispatchEvent(new CustomEvent('openServerSettings',{detail:server.id}))} className="px-2 py-1 rounded bg-white/6">‚öôÔ∏è</button>
              </div>
            </div>

            <div className="text-xs text-[#94a3b8] mb-2">TEXTKANALER</div>
            <div className="flex-1 overflow-auto scrollbar-thin">
              {Object.values(server.channels).map(ch=>(
                <div key={ch.id} onClick={()=>setActiveChannel(ch.id)} className={`px-3 py-2 rounded cursor-pointer ${activeChannel===ch.id ? 'bg-white/6' : 'hover:bg-white/5'}`}>
                  # {ch.name}
                </div>
              ))}
            </div>
            <div className="mt-3">
              { (server.owner === me || hasPermission(server, me, 'manage_channels')) ? (
                <button onClick={onCreateChannel} className="w-full py-2 rounded bg-white/6">+ Ny kanal</button>
              ) : (
                <div className="text-xs text-[#94a3b8]">Ingen r√§tt att skapa kanal</div>
              )}
            </div>
          </div>
        );
      }

      function MemberPanel({ server, me, onOpenInviteModal, onAssignRole }) {
        if(!server) return (
          <div className="w-64 bg-[#071428] p-3 border-l border-black/20 flex items-center">
            <div className="text-sm text-[#94a3b8]">V√§lj en server</div>
          </div>
        );
        return (
          <div className="w-64 bg-[#071428] p-3 border-l border-black/20 flex flex-col">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold">Medlemmar</div>
              { (server.owner === me || hasPermission(server, me, 'invite_members')) ? (
                <button onClick={()=>onOpenInviteModal()} className="text-xs bg-white/6 px-2 py-1 rounded">Bjud in</button>
              ) : null }
            </div>

            <div className="flex-1 overflow-auto scrollbar-thin">
              {server.members.map(m=>(
                <div key={m} className="flex items-center justify-between px-2 py-1 hover:bg-white/5 rounded">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{m[0]}</div>
                    <div>
                      <div className="font-medium">{m}</div>
                      <div className="text-xs text-[#94a3b8]">{server.memberRoles?.[m] || 'Member'}</div>
                    </div>
                  </div>
                  <div className="flex items-center gap-1">
                    <button onClick={()=>onOpenInviteModal(m)} className="text-xs bg-white/6 px-2 py-1 rounded">DM</button>
                    { (server.owner === me || hasPermission(server, me, 'manage_roles')) && (
                      <button onClick={()=>onAssignRole(m)} className="text-xs bg-white/6 px-2 py-1 rounded">Roll</button>
                    )}
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-3">
              <div className="text-xs text-[#94a3b8] mb-1">Din anv√§ndare</div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 rounded-full bg-[#1e2a3a] flex items-center justify-center">{me[0]}</div>
                  <div>
                    <div className="font-medium">{me}</div>
                    <div className="text-xs text-[#94a3b8]">Status: online</div>
                  </div>
                </div>
                <div>
                  <button onClick={()=>{ saveSession(null); location.reload(); }} className="text-xs bg-red-600/30 px-2 py-1 rounded">Logga ut</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /****************************************
       * Messages panel & composer
       ****************************************/
      function MessagesPanel({ server, channelId, me, onDelete, onReact }) {
        const ch = server?.channels?.[channelId];
        const ref = useRef();
        if(!server) return <div className="flex-1 flex items-center justify-center">V√§lj en server</div>;
        if(!ch) return <div className="flex-1 flex items-center justify-center">V√§lj en kanal</div>;

        function sendMsg(){
          const v = ref.current.value.trim();
          if(!v) return;
          if(!hasPermission(server, me, 'create_messages')) return alert('Ingen r√§ttighet att skicka meddelanden h√§r');
          const id = Date.now().toString();
          ch.messages.push({ id, user:me, text:v, ts:new Date().toISOString(), reactions: {} });
          saveData(dataRef.current);
          ref.current.value='';
          window.dispatchEvent(new Event('dataUpdated'));
        }

        return (
          <div className="flex-1 flex flex-col">
            <div className="flex-1 overflow-auto p-6 scrollbar-thin">
              <div className="max-w-3xl flex flex-col gap-4">
                {ch.messages.length === 0 && <div className="text-[#94a3b8]">Inga meddelanden √§n...</div>}
                {ch.messages.map(m=>(
                  <div key={m.id} className="flex gap-3">
                    <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{m.user[0]}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-3">
                        <div className="font-medium">{m.user}</div>
                        <div className="text-xs text-[#94a3b8]">{new Date(m.ts).toLocaleTimeString()}</div>
                        <div className="ml-auto flex gap-2">
                          { (m.user === me || hasPermission(server, me, 'delete_messages') || server.owner === me) && (
                            <button onClick={()=>{ if(confirm('Radera meddelande?')) onDelete(ch.id, m.id); }} className="text-xs text-red-400">Radera</button>
                          )}
                        </div>
                      </div>
                      <div className="mt-1">{m.text}</div>
                      <div className="mt-2 flex gap-2 items-center">
                        { Object.entries(m.reactions || {}).map(([emoji,count])=>(
                          <div key={emoji} className="bg-white/10 px-2 rounded cursor-pointer" onClick={()=>onReact(ch.id, m.id, emoji)}>{emoji} {count}</div>
                        ))}
                        <button onClick={()=>{
                          const e = prompt('V√§lj emoji att reagera med (ex: üëç,üòÇ,‚ù§Ô∏è):');
                          if(e) onReact(ch.id, m.id, e);
                        }} className="text-xs text-[#94a3b8]">+ Reagera</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="p-4 border-t border-black/20">
              <div className="max-w-3xl mx-auto flex gap-2">
                <textarea ref={ref} placeholder={`Skriv i #${ch.name}...`} className="flex-1 bg-[#071225] rounded px-4 py-2 outline-none resize-none" rows="2"></textarea>
                <button onClick={sendMsg} className="bg-[--accent] px-4 py-2 rounded">Skicka</button>
              </div>
            </div>
          </div>
        );
      }

      /****************************************
       * Server settings modal (owner / manage_server)
       ****************************************/
      function ServerSettingsModal({ serverId, onClose, onSave }) {
        const d = loadData();
        const server = d.servers[serverId];
        const [name, setName] = useState(server?.name || '');
        const [rolesDef, setRolesDef] = useState(JSON.parse(JSON.stringify(server.roles || {})));

        if(!server) return null;

        function togglePerm(role, perm){
          const copy = {...rolesDef};
          copy[role].permissions[perm] = !copy[role].permissions[perm];
          setRolesDef(copy);
        }
        function save(){
          const dd = loadData();
          dd.servers[serverId].name = name;
          dd.servers[serverId].roles = rolesDef;
          saveData(dd);
          onSave();
        }

        return (
          <div className="modal-backdrop">
            <div className="bg-[#0b1220] rounded p-6 w-2/3 max-w-3xl">
              <div className="flex justify-between items-center mb-4">
                <div className="text-lg font-semibold">Serverinst√§llningar ‚Äî {server.name}</div>
                <div className="text-xs text-[#94a3b8]">√Ñgare: {server.owner}</div>
              </div>

              <div className="mb-4">
                <label className="text-xs text-[#94a3b8]">Namn</label>
                <input value={name} onChange={e=>setName(e.target.value)} className="w-full p-2 bg-[#071225] rounded mt-1"/>
              </div>

              <div className="mb-4">
                <div className="font-medium mb-2">Roller & Permissions</div>
                {Object.keys(rolesDef).map(role => (
                  <div key={role} className="mb-3 p-3 bg-[#071428] rounded">
                    <div className="flex items-center justify-between mb-2">
                      <div className="font-semibold">{role}</div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-xs">
                      {['manage_server','manage_roles','manage_channels','delete_messages','create_messages','invite_members'].map(perm => (
                        <label key={perm} className="flex items-center gap-2">
                          <input type="checkbox" checked={!!rolesDef[role].permissions[perm]} onChange={()=>togglePerm(role,perm)} />
                          <span className="capitalize">{perm.replace('_',' ')}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                ))}
              </div>

              <div className="flex justify-end gap-2">
                <button onClick={onClose} className="px-4 py-2 rounded bg-white/6">Avbryt</button>
                <button onClick={save} className="px-4 py-2 rounded bg-[--accent]">Spara</button>
              </div>
            </div>
          </div>
        );
      }

      /****************************************
       * Invite modal (shows all registered users; owner/admin can invite)
       ****************************************/
      function InviteModal({ serverId, me, onClose, onInviteComplete }) {
        const [allUsers, setAllUsers] = useState(Object.keys(loadUsers()));
        const [selected, setSelected] = useState(null);
        const data = loadData();
        const server = data.servers[serverId];

        useEffect(()=> {
          setAllUsers(Object.keys(loadUsers()));
        }, []);

        function invite(userToInvite){
          if(!server) return;
          if(server.members.includes(userToInvite)) { alert(userToInvite + ' √§r redan medlem'); return; }
          // permission check
          if(!(server.owner === me || hasPermission(server, me, 'invite_members'))) { alert('Ingen r√§tt att bjuda in'); return; }
          const copy = JSON.parse(JSON.stringify(data));
          copy.servers[serverId].members.push(userToInvite);
          copy.servers[serverId].memberRoles[userToInvite] = 'Member';
          saveData(copy);
          onInviteComplete();
          alert(userToInvite + ' inbjuden!');
        }

        return (
          <div className="modal-backdrop">
            <div className="bg-[#0b1220] rounded p-4 w-96">
              <div className="flex justify-between items-center mb-3">
                <div className="font-semibold">Bjud in anv√§ndare ‚Äî {server?.name}</div>
                <button onClick={onClose} className="px-2 py-1 rounded bg-white/6">St√§ng</button>
              </div>
              <div className="text-xs text-[#94a3b8] mb-2">Alla registrerade anv√§ndare</div>
              <div className="max-h-64 overflow-auto scrollbar-thin">
                {allUsers.map(u=>(
                  <div key={u} className="flex items-center justify-between gap-3 px-2 py-1 hover:bg-white/5 rounded">
                    <div className="flex items-center gap-2">
                      <div className="w-8 h-8 rounded-full bg-[#1e2a3a] flex items-center justify-center">{u[0]}</div>
                      <div>
                        <div className="font-medium">{u}</div>
                        <div className="text-xs text-[#94a3b8]">{u === me ? 'Du' : 'Registrerad'}</div>
                      </div>
                    </div>
                    <div>
                      <button onClick={()=>invite(u)} className="text-xs bg-[--accent] px-2 py-1 rounded">Bjud in</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      /****************************************
       * Global data ref and App
       ****************************************/
      const dataRef = { current: loadData() };

      function App(){
        const [me, setMe] = useState(loadSession());
        const [usersState, setUsersState] = useState(loadUsers());
        const [dataState, setDataState] = useState(loadData());
        dataRef.current = dataState;

        // UI state
        const [activeServer, setActiveServer] = useState(Object.keys(dataState.servers)[0] || null);
        const [activeChannel, setActiveChannel] = useState(() => {
          const s = dataState.servers[Object.keys(dataState.servers)[0]];
          return s ? Object.keys(s.channels)[0] : null;
        });
        const [showSettingsFor, setShowSettingsFor] = useState(null);
        const [showInviteFor, setShowInviteFor] = useState(null);

        // listen for external events
        useEffect(()=>{
          function onUpdate(){ const fresh = loadData(); setDataState(fresh); dataRef.current = fresh; }
          window.addEventListener('dataUpdated', onUpdate);
          function onOpenSettings(e){ setShowSettingsFor(e.detail); }
          document.addEventListener('openServerSettings', onOpenSettings);
          return ()=>{ window.removeEventListener('dataUpdated', onUpdate); document.removeEventListener('openServerSettings', onOpenSettings); };
        }, []);

        // persist when states change
        useEffect(()=>{ saveData(dataState); }, [dataState]);
        useEffect(()=>{ saveUsers(usersState); }, [usersState]);

        // login handler
        function handleLogin(user){
          setMe(user);
          saveSession(user);
          // ensure user is member of existing servers
          const copy = JSON.parse(JSON.stringify(dataState));
          Object.values(copy.servers).forEach(s=>{
            if(!s.members.includes(user)){ s.members.push(user); s.memberRoles[user] = 'Member'; }
          });
          setDataState(copy);
        }

        function handleRegister(user, pw){
          const us = {...usersState};
          us[user] = { pw: hashPw(pw), created: Date.now() };
          setUsersState(us);
        }

        function createServer(){
          const name = prompt('Namn p√• server:');
          if(!name) return;
          const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Math.floor(Math.random()*10000);
          const copy = JSON.parse(JSON.stringify(dataState));
          copy.servers[id] = {
            id, name, icon: name[0].toUpperCase(),
            owner: me,
            roles: JSON.parse(JSON.stringify(defaultData().servers.home.roles)),
            members: [me],
            memberRoles: { [me]:'Owner' },
            channels: { general: { id:'general', name:'general', messages:[] } },
            invites: []
          };
          setDataState(copy);
          setActiveServer(id);
          setActiveChannel('general');
        }

        function createChannel(){
          if(!activeServer) return alert('V√§lj server');
          const server = dataState.servers[activeServer];
          if(!(server.owner === me || hasPermission(server, me, 'manage_channels'))) return alert('Ingen r√§tt att skapa kanal');
          const name = prompt('Namn p√• kanal (utan mellanslag):');
          if(!name) return;
          const copy = JSON.parse(JSON.stringify(dataState));
          copy.servers[activeServer].channels[name] = { id:name, name, messages:[] };
          setDataState(copy);
          setActiveChannel(name);
        }

        function deleteMessage(channelId, msgId){
          const copy = JSON.parse(JSON.stringify(dataState));
          const ch = copy.servers[activeServer].channels[channelId];
          if(!ch) return;
          const idx = ch.messages.findIndex(m=>m.id===msgId);
          if(idx === -1) return;
          ch.messages.splice(idx,1);
          setDataState(copy);
        }

        function assignRoleToMember(targetUser){
          const server = dataState.servers[activeServer];
          if(!server) return;
          if(server.owner !== me && !hasPermission(server, me, 'manage_roles')) return alert('Ingen r√§tt att tilldela roller');
          const role = prompt('Ange roll f√∂r '+targetUser+' (Owner/Admin/Mod/Member):');
          if(!role) return;
          if(!server.roles[role]) return alert('Ok√§nd roll');
          const copy = JSON.parse(JSON.stringify(dataState));
          copy.servers[activeServer].memberRoles[targetUser] = role;
          setDataState(copy);
        }

        function openInviteModal(serverId){
          setShowInviteFor(serverId);
        }

        function inviteComplete(){
          setShowInviteFor(null);
          setDataState(loadData());
        }

        function deleteServer(serverId){
          const s = dataState.servers[serverId];
          if(!s) return;
          if(s.owner !== me && !hasPermission(s, me, 'manage_server')) return alert('Ingen r√§tt att ta bort servern');
          if(!confirm('Radera server '+s.name+'?')) return;
          const copy = JSON.parse(JSON.stringify(dataState));
          delete copy.servers[serverId];
          setDataState(copy);
          const keys = Object.keys(copy.servers);
          setActiveServer(keys[0] || null);
          setActiveChannel(keys[0] ? Object.keys(copy.servers[keys[0]].channels)[0] : null);
        }

        function reactMessage(channelId, msgId, emoji){
          const copy = JSON.parse(JSON.stringify(dataState));
          const ch = copy.servers[activeServer].channels[channelId];
          if(!ch) return;
          const m = ch.messages.find(x=>x.id===msgId);
          if(!m) return;
          m.reactions = m.reactions || {};
          m.reactions[emoji] = (m.reactions[emoji] || 0) + 1;
          setDataState(copy);
        }

        // Save server settings callback
        function onSettingsSaved(){ setShowSettingsFor(null); setDataState(loadData()); }

        // Show list of all registered users in a small panel? We'll keep invite modal for invites
        // Render login if not logged in
        if(!me) return <Auth onLogin={(u)=>{ handleLogin(u); }} />;

        const activeServerObj = activeServer ? dataState.servers[activeServer] : null;

        return (
          <div className="flex h-screen">
            <ServerSidebar servers={dataState.servers} activeServer={activeServer} setActiveServer={(s)=>{ setActiveServer(s); setActiveChannel(null); }} onCreateServer={createServer} />

            <ChannelsPanel server={activeServerObj} activeChannel={activeChannel} setActiveChannel={(c)=>setActiveChannel(c)} onCreateChannel={createChannel} me={me} />

            <div className="flex-1 flex flex-col">
              <div className="flex justify-between items-center px-6 py-4 border-b border-black/30">
                <div>
                  {activeServerObj ? <div className="text-lg font-semibold">{activeServerObj.name} ‚Äî {activeChannel || ''}</div> : <div className="text-lg font-semibold">Hem (DMs)</div>}
                  <div className="text-xs text-[#94a3b8]">{activeServerObj ? `√Ñgare: ${activeServerObj.owner}` : 'Direktmeddelanden'}</div>
                </div>
                <div className="flex items-center gap-3">
                  {activeServerObj && activeServerObj.owner === me && <button onClick={()=>setShowSettingsFor(activeServerObj.id)} className="px-3 py-1 rounded bg-white/6">Inst√§llningar</button>}
                  {activeServerObj && <button onClick={()=>deleteServer(activeServerObj.id)} className="px-3 py-1 rounded bg-red-600/30">Radera</button>}
                  <div className="text-xs text-[#94a3b8]">Inloggad som {me}</div>
                </div>
              </div>

              <MessagesPanel server={activeServerObj} channelId={activeChannel} me={me} onDelete={deleteMessage} onReact={reactMessage} />
            </div>

            <MemberPanel server={activeServerObj} me={me} onOpenInviteModal={()=>openInviteModal(activeServer)} onAssignRole={assignRoleToMember} />

            { showSettingsFor && <ServerSettingsModal serverId={showSettingsFor} onClose={()=>setShowSettingsFor(null)} onSave={onSettingsSaved} /> }
            { showInviteFor && <InviteModal serverId={showInviteFor} me={me} onClose={()=>setShowInviteFor(null)} onInviteComplete={inviteComplete} /> }
          </div>
        );
      }

      /****************************************
       * Boot: create minimal initial user (Anna) if none exist
       ****************************************/
      (function bootstrap(){
        const users = loadUsers();
        if(Object.keys(users).length === 0){
          // create a few demo users so UI isn't empty
          users['Anna'] = { pw: hashPw('demo'), created: Date.now() };
          users['Bj√∂rn'] = { pw: hashPw('demo'), created: Date.now() };
          users['Cara'] = { pw: hashPw('demo'), created: Date.now() };
          saveUsers(users);
        }
        const data = loadData();
        // ensure member lists include registered users as Member if not already present
        const regUsers = Object.keys(loadUsers());
        Object.values(data.servers).forEach(s=>{
          regUsers.forEach(u=>{
            if(!s.members.includes(u)){
              s.members.push(u);
              s.memberRoles[u] = s.memberRoles[u] || 'Member';
            }
          });
        });
        saveData(data);
      })();

      /****************************************
       * Render
       ****************************************/
      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
