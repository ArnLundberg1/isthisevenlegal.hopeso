<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Discord-klon — Servrar & DMs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{
        --bg:#0f1724;
        --panel:#0b1220;
        --muted:#94a3b8;
        --accent:#5865f2;
      }
      body { background: linear-gradient(180deg,var(--bg),#071027); }
      .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
      .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
      .server-icon { width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700; }
      .modal-backdrop{ background: rgba(0,0,0,0.6); position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; }
    </style>
  </head>
  <body class="min-h-screen text-sm text-white">
    <div id="root"></div>

    <!-- React + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      /****************************************
       * Storage helpers
       ****************************************/
      const USERS_KEY = 'discord_clone_users_v3';
      const DATA_KEY = 'discord_clone_data_v3';
      const SESSION_KEY = 'discord_clone_session_v3';

      function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)) || {}; }catch(e){ return {}; } }
      function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
      function loadData(){ try{ return JSON.parse(localStorage.getItem(DATA_KEY)) || defaultData(); }catch(e){ return defaultData(); } }
      function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
      function loadSession(){ return localStorage.getItem(SESSION_KEY); }
      function saveSession(u){ if(u) localStorage.setItem(SESSION_KEY,u); else localStorage.removeItem(SESSION_KEY); }
      function hashPw(pw){ return btoa(pw); }

      function defaultData(){
        return {
          servers:{},
          dms:{} // DM-konversationer: key "A|B" => [{user,text,ts}]
        };
      }

      /****************************************
       * Auth UI
       ****************************************/
      function Auth({ onLogin }){
        const [tab,setTab] = useState('login');
        return (
          <div className="flex items-center justify-center h-screen">
            <div className="w-96 bg-[#0f1724] p-6 rounded-2xl shadow-xl">
              <h1 className="text-xl font-semibold mb-4">Discord-klon</h1>
              <div className="flex gap-2 mb-4">
                <button onClick={()=>setTab('login')} className={`flex-1 py-2 rounded ${tab==='login'?'bg-white/6':''}`}>Logga in</button>
                <button onClick={()=>setTab('register')} className={`flex-1 py-2 rounded ${tab==='register'?'bg-white/6':''}`}>Skapa konto</button>
              </div>
              {tab==='login' ? <LoginForm onLogin={onLogin}/> : <RegisterForm onRegister={onLogin}/>}
            </div>
          </div>
        );
      }

      function LoginForm({ onLogin }){
        const [user,setUser]=useState(''); const [pw,setPw]=useState('');
        function submit(e){ e.preventDefault();
          const us=loadUsers();
          if(!us[user]) return alert("Ingen användare");
          if(us[user].pw!==hashPw(pw)) return alert("Fel lösenord");
          saveSession(user); onLogin(user);
        }
        return (
          <form onSubmit={submit} className="flex flex-col gap-3">
            <input value={user} onChange={e=>setUser(e.target.value)} placeholder="Användarnamn" className="p-2 bg-[#071225] rounded"/>
            <input type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="Lösenord" className="p-2 bg-[#071225] rounded"/>
            <button className="bg-[--accent] py-2 rounded">Logga in</button>
            <button type="button" onClick={()=>{
              const g="google_"+Math.floor(Math.random()*100000);
              const us=loadUsers();
              if(!us[g]){ us[g]={pw:hashPw("demo"),created:Date.now()}; saveUsers(us); }
              saveSession(g); onLogin(g);
            }} className="bg-white/6 py-2 rounded">Logga in med Google (demo)</button>
          </form>
        );
      }

      function RegisterForm({ onRegister }){
        const [user,setUser]=useState(''); const [pw,setPw]=useState(''); const [pw2,setPw2]=useState('');
        function submit(e){ e.preventDefault();
          if(!user.trim()) return alert("Användarnamn krävs");
          if(pw.length<4) return alert("Lösenord minst 4 tecken");
          if(pw!==pw2) return alert("Lösenord matchar ej");
          const us=loadUsers();
          if(us[user]) return alert("Upptaget namn");
          us[user]={pw:hashPw(pw),created:Date.now()}; saveUsers(us);
          saveSession(user); onRegister(user);
        }
        return (
          <form onSubmit={submit} className="flex flex-col gap-3">
            <input value={user} onChange={e=>setUser(e.target.value)} placeholder="Användarnamn" className="p-2 bg-[#071225] rounded"/>
            <input type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="Lösenord" className="p-2 bg-[#071225] rounded"/>
            <input type="password" value={pw2} onChange={e=>setPw2(e.target.value)} placeholder="Bekräfta" className="p-2 bg-[#071225] rounded"/>
            <button className="bg-[--accent] py-2 rounded">Skapa konto</button>
          </form>
        );
      }

      /****************************************
       * DM & Chat utils
       ****************************************/
      function dmKey(u1,u2){ return [u1,u2].sort().join('|'); }

      /****************************************
       * Main App
       ****************************************/
      function App(){
        const [me,setMe]=useState(loadSession());
        const [data,setData]=useState(loadData());
        const [activeServer,setActiveServer]=useState(null);
        const [activeChannel,setActiveChannel]=useState(null);
        const [activeDM,setActiveDM]=useState(null);

        useEffect(()=>{ saveData(data); },[data]);

        if(!me) return <Auth onLogin={(u)=>{ setMe(u); }}/>;

        // --- DM panel ---
        function DMPanel(){
          const dms=data.dms||{};
          const myKeys=Object.keys(dms).filter(k=>k.includes(me));
          return (
            <div className="w-64 bg-[#0b1220] p-3 border-r border-black/20 flex flex-col">
              <div className="font-semibold mb-2">Direktmeddelanden</div>
              <div className="flex-1 overflow-auto scrollbar-thin">
                {myKeys.map(k=>{
                  const other=k.split('|').find(x=>x!==me);
                  return <div key={k} onClick={()=>{setActiveDM(k);setActiveServer(null);}} className={`px-3 py-2 rounded cursor-pointer ${activeDM===k?'bg-white/6':'hover:bg-white/5'}`}>{other}</div>;
                })}
              </div>
            </div>
          );
        }

        function Messages({msgs,onSend,onDelete,onReact}){
          const ref=useRef();
          function send(){ const v=ref.current.value.trim(); if(!v) return; onSend(v); ref.current.value=''; }
          return (
            <div className="flex-1 flex flex-col">
              <div className="flex-1 overflow-auto p-6 scrollbar-thin">
                <div className="max-w-3xl flex flex-col gap-4">
                  {msgs.map(m=><div key={m.id} className="flex gap-3">
                    <div className="w-10 h-10 rounded-full bg-[#20324a] flex items-center justify-center font-semibold">{m.user[0]}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-3">
                        <div className="font-medium">{m.user}</div>
                        <div className="text-xs text-[#94a3b8]">{new Date(m.ts).toLocaleTimeString()}</div>
                        {(m.user===me) && <button onClick={()=>onDelete(m.id)} className="ml-auto text-xs text-red-400">Radera</button>}
                      </div>
                      <div>{m.text}</div>
                      <div className="mt-1 flex gap-2">
                        {Object.entries(m.reactions||{}).map(([e,c])=><div key={e} className="bg-white/10 px-2 rounded cursor-pointer" onClick={()=>onReact(m.id,e)}>{e} {c}</div>)}
                        <button onClick={()=>{const e=prompt("Emoji:"); if(e) onReact(m.id,e);}} className="text-xs text-[#94a3b8]">+ Reagera</button>
                      </div>
                    </div>
                  </div>)}
                </div>
              </div>
              <div className="p-4 border-t border-black/20">
                <div className="max-w-3xl mx-auto flex gap-2">
                  <textarea ref={ref} rows="2" placeholder="Skriv..." className="flex-1 bg-[#071225] rounded px-4 py-2 resize-none"></textarea>
                  <button onClick={send} className="bg-[--accent] px-4 py-2 rounded">Skicka</button>
                </div>
              </div>
            </div>
          );
        }

        // active DM view
        if(activeDM){
          const msgs=data.dms[activeDM]||[];
          function send(text){
            const copy={...data};
            copy.dms[activeDM]=[...msgs,{id:Date.now(),user:me,text,ts:new Date().toISOString(),reactions:{}}];
            setData(copy);
          }
          function del(id){
            const copy={...data};
            copy.dms[activeDM]=msgs.filter(m=>m.id!==id);
            setData(copy);
          }
          function react(id,e){
            const copy={...data};
            const m=copy.dms[activeDM].find(x=>x.id===id);
            m.reactions[m.reactions?e:'']={...(m.reactions||{}),[e]:(m.reactions?.[e]||0)+1};
            setData(copy);
          }
          return (
            <div className="flex h-screen">
              <DMPanel/>
              <Messages msgs={msgs} onSend={send} onDelete={del} onReact={react}/>
              <div className="w-64 bg-[#071428] p-3 border-l border-black/20">
                <div className="font-semibold mb-2">DM med {activeDM.split('|').find(x=>x!==me)}</div>
                <button onClick={()=>setActiveDM(null)} className="bg-white/6 px-2 py-1 rounded">Tillbaka</button>
              </div>
            </div>
          );
        }

        // just render DM panel + empty
        return (
          <div className="flex h-screen">
            <DMPanel/>
            <div className="flex-1 flex items-center justify-center text-[#94a3b8]">Välj en DM till vänster</div>
            <div className="w-64 bg-[#071428] p-3 border-l border-black/20">
              <div className="font-semibold mb-2">Du: {me}</div>
              <button onClick={()=>{saveSession(null);location.reload();}} className="bg-red-600/30 px-2 py-1 rounded">Logga ut</button>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  </body>
</html>
